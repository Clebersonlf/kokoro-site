<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kokoro â€” Cadastro</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .ok { color: #0a7; } .bad { color: #c00; }
    button { padding: 10px 16px; font-size: 16px; }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 10px; max-width: 560px;}
    .muted { color:#666; font-size:14px }
  </style>
</head>
<body>
  <h1>Kokoro â€” Cadastro</h1>
  <div class="card">
    <div id="status">Verificando tokenâ€¦</div>
    <div id="dados" class="muted" style="margin:8px 0 16px 0;"></div>
    <button id="btnConcluir" disabled>Concluir cadastro</button>
    <div id="resultado" style="margin-top:16px;"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const token = (qs.get('token') || '').trim();

    const elStatus    = document.getElementById('status');
    const elDados     = document.getElementById('dados');
    const elBtn       = document.getElementById('btnConcluir');
    const elResultado = document.getElementById('resultado');

    if (!token) {
      elStatus.innerHTML = '<span class="bad">Token ausente na URL (?token=)</span>';
    } else {
      // 1) Validar
      fetch(`/api/convites/validar?token=${encodeURIComponent(token)}`)
        .then(r => r.json())
        .then(j => {
          if (!j.ok) throw new Error(j.error || 'Falha ao validar');
          const c = j.data;
          elDados.textContent = c ? `Nome: ${c.nome || '-'} â€” E-mail: ${c.email}` : '';
          if (j.valid) {
            elStatus.innerHTML = '<span class="ok">Token vÃ¡lido. VocÃª pode concluir o cadastro.</span>';
            elBtn.disabled = false;
          } else {
            elStatus.innerHTML = '<span class="bad">Token invÃ¡lido ou jÃ¡ utilizado.</span>';
            elBtn.disabled = true;
          }
        })
        .catch(err => {
          elStatus.innerHTML = `<span class="bad">Erro ao validar: ${String(err)}</span>`;
        });
    }

    // 2) Concluir (chama /usar)
    elBtn.addEventListener('click', async () => {
      elBtn.disabled = true;
      elResultado.textContent = 'Concluindoâ€¦';
      try {
        const r = await fetch('/api/convites/usar', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ token })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || 'Falha ao concluir');
        elResultado.innerHTML = `<span class="ok">Cadastro concluÃ­do! ðŸŽ‰</span>`;
        elStatus.innerHTML = '<span class="ok">Status: concluÃ­do</span>';
      } catch (e) {
        elResultado.innerHTML = `<span class="bad">Erro: ${String(e)}</span>`;
        elBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
