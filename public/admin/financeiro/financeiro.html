<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KOKORO — Controle Financeiro</title>

  <style>
    :root{
      --bg:#0f1115;
      --card:#161a22;
      --card2:#131722;
      --border:#2a3140;
      --text:#e7e9ee;
      --muted:#a9b2c3;
      --blue:#3498db;
      --green:#2ecc71;
      --red:#e74c3c;
      --orange:#f39c12;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:28px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      background: radial-gradient(900px 420px at 50% 0%, rgba(52,152,219,.18), transparent 55%) , var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 18px;text-align:center;color:var(--blue);letter-spacing:.3px}

    .panel{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      margin-bottom:18px;
    }

    .resumo{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
    }
    .box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:rgba(0,0,0,.12);
      text-align:center;
    }
    .box .t{font-size:12px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.4px}
    .box .v{margin-top:8px;font-size:20px;font-weight:900}
    .v.green{color:var(--green)}
    .v.red{color:var(--red)}
    .v.blue{color:var(--text)}
    .v.orange{color:var(--orange)}
    .hint{margin-top:6px;font-size:11px;color:var(--muted)}

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 160px 220px 260px 160px;
      gap:12px;
      align-items:end;
    }
    input,select{
      width:100%;
      padding:11px 12px;
      background:#0f1320;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus{border-color:rgba(52,152,219,.8); box-shadow:0 0 0 3px rgba(52,152,219,.15)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .btn{
      padding:11px 14px;
      border-radius:10px;
      border:1px solid transparent;
      cursor:pointer;
      font-weight:800;
      transition:.15s ease;
      width:100%;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn-primary{background:var(--blue); color:#fff}
    .btn-cancel{background:transparent;border-color:var(--border);color:var(--text);display:none}
    .btn-cancel.show{display:block}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead th{
      text-align:left;
      font-size:12px;
      color:#cfe4ff;
      background:#101827;
      border-bottom:1px solid var(--border);
      padding:12px 12px;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      color:var(--text);
      font-size:14px;
      vertical-align:middle;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .right{text-align:right;white-space:nowrap}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .a{
      border:none;border-radius:10px;padding:8px 10px;cursor:pointer;
      font-weight:800;font-size:12px;color:#fff;
    }
    .a.edit{background:var(--orange)}
    .a.del{background:var(--red)}

    @media (max-width: 980px){
      .resumo{grid-template-columns: 1fr 1fr}
      .form-grid{grid-template-columns: 1fr 1fr; }
    }
  
    .btn-back{
      display:inline-block;
      background:var(--blue);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      text-decoration:none;
      font-weight:800;
      border:1px solid transparent;
      transition:.15s ease;
    }
    .btn-back:hover{filter:brightness(1.06)}

  </style>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght;500;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/admin/admin.css"></head>

<body>
  <div class="wrap">
    <h1>Controle Financeiro</h1>
    <div style="margin: 10px 0 18px 0;">
      <a href="/admin" class="btn-back">Voltar ao Dashboard</a>
    </div>

    <div class="panel">
      <div class="resumo">
        <div class="box">
          <div class="t">Total Receitas</div>
          <div id="total-receitas" class="v green">R$ 0,00</div>
        </div>
        <div class="box">
          <div class="t">Total Despesas</div>
          <div id="total-despesas" class="v red">R$ 0,00</div>
        </div>
        <div class="box">
          <div class="t">Saldo Final</div>
          <div id="saldo-final" class="v blue">R$ 0,00</div>
        </div>
        <div class="box">
          <div class="t">Débito Interno</div>
          <div id="total-debito" class="v orange">R$ 0,00</div>
          <div class="hint">Parcelamento direto sem juros</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2 style="margin:0 0 14px;color:#fff;font-size:18px">Adicionar Receita / Débito / Despesa</h2>

      <form id="form-receita">
        <div class="form-grid">
          <div>
            <label for="aluno">Aluno</label>
            <input id="aluno" placeholder="Ex.: João Silva" />
          </div>

          <div>
            <label for="descricao">Descrição</label>
            <input id="descricao" placeholder="Ex.: Exame faixa preta / Mensalidade" />
          </div>

          <div>
            <label for="valor">Valor (R$)</label>
            <input id="valor" type="number" step="0.01" placeholder="0,00" />
          </div>

          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo">
              <option value="receita">Receita</option>
              <option value="debito">Débito Interno</option>
              <option value="despesa">Despesa</option>
            </select>
          </div>

          <!-- ✅ AGORA EXISTE: seletor para abater em uma dívida -->
          <div id="wrap-debito-ref" style="display:none">
            <label for="debito-ref">Abater em qual dívida?</label>
            <select id="debito-ref">
              <option value="">Abater em... (selecione a dívida)</option>
            </select>
            <div class="hint">Este pagamento será abatido da dívida selecionada.</div>
          </div>

          <div style="display:grid;gap:10px">
            <button class="btn btn-primary" type="submit" id="btn-salvar">Adicionar</button>
            <button class="btn btn-cancel" type="button" id="btn-cancelar">Cancelar edição</button>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          Dica: “Débito Interno” = aluno está devendo e você vai lançando os pagamentos depois como “Receita”.
        </div>
      </form>
    </div>

    <!-- ✅ AGORA EXISTE: painel com blocos por aluno e histórico de abatimentos -->
    <div class="panel">
      <h2 style="margin:0 0 10px;color:#fff;font-size:18px">Dívidas por aluno (com abatimentos)</h2>
      <div id="blocos-debitos"></div>
    </div>

    <div class="panel">
      <h2 style="margin:0 0 10px;color:#fff;font-size:18px">Histórico</h2>

      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Aluno</th>
            <th>Descrição</th>
            <th class="right">Valor</th>
            <th>Tipo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela"></tbody>
      </table>
    </div>
  </div>

  <script>

// --- CONEXÃO COM API ---
const API_URL = "/api/financeiro/lancamentos";

async function carregarDados() {
  try {
    const r = await fetch(API_URL);
    const js = await r.json();
    if (js.ok) {
      dados = js.data || [];
      atualizar();
    }
  } catch (e) { console.error("Erro ao carregar:", e); }
}

async function salvarNoServidor(item, method = "POST") {
  try {
    const url = method === "PUT" ? `${API_URL}?id=${item.id}` : API_URL;
    const r = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(item)
    });
    const js = await r.json();
    if (!js.ok) alert("Erro ao salvar: " + js.message);
    await carregarDados(); // Recarrega do banco
  } catch (e) { alert("Erro de conexão com servidor."); }
}

async function excluirNoServidor(id) {
  if (!confirm("Excluir permanentemente?")) return;
  try {
    const r = await fetch(`${API_URL}?id=${id}`, { method: "DELETE" });
    await carregarDados();
  } catch (e) { alert("Erro ao excluir."); }
}

// Substituindo as funções antigas
function salvar() { /* desativado localStorage */ }

// Inicialização
document.addEventListener("DOMContentLoaded", carregarDados);


function moeda(v) {
  return (Number(v) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function hoje() {
  return new Date().toLocaleDateString("pt-BR");
}

function genId() {
  return Date.now() + "_" + Math.random().toString(16).slice(2);
}

function normalizarAluno(s) {
  return (s || "").trim();
}

function getDebitosPorAluno() {
  const debitos = dados.filter(x => x.tipo === "debito");
  const pagamentos = dados.filter(x => x.tipo === "receita" && x.refDebitoId);

  const mapa = new Map();
  for (const d of debitos) {
    mapa.set(d.debitoId, {
      debito: d,
      pagamentos: [],
      pagoTotal: 0,
      saldo: Number(d.valor) || 0,
    });
  }

  for (const p of pagamentos) {
    if (!mapa.has(p.refDebitoId)) continue;
    const reg = mapa.get(p.refDebitoId);
    reg.pagamentos.push(p);
    reg.pagoTotal += Number(p.valor) || 0;
    reg.saldo = Math.max(0, (Number(reg.debito.valor) || 0) - reg.pagoTotal);
  }

  const porAluno = new Map();
  for (const [debtId, reg] of mapa.entries()) {
    const aluno = normalizarAluno(reg.debito.aluno);
    if (!porAluno.has(aluno)) porAluno.set(aluno, []);
    porAluno.get(aluno).push({ debtId, ...reg });
  }

  for (const [aluno, lista] of porAluno.entries()) {
    lista.sort((a,b) => (b.debito._ts||0) - (a.debito._ts||0));
  }

  return porAluno;
}

function atualizarSelectAbatimento() {
  const tipo = selTipo.value;
  const aluno = normalizarAluno(inpAluno.value);

  if (tipo !== "receita") {
    wrapDebitoRef.style.display = "none";
    selDebitoRef.innerHTML = `<option value="">Abater em... (selecione a dívida)</option>`;
    return;
  }

  const porAluno = getDebitosPorAluno();
  const lista = porAluno.get(aluno) || [];
  const abertas = lista.filter(x => x.saldo > 0);

  if (!aluno || abertas.length === 0) {
    wrapDebitoRef.style.display = "none";
    selDebitoRef.innerHTML = `<option value="">Abater em... (selecione a dívida)</option>`;
    return;
  }

  wrapDebitoRef.style.display = "block";
  selDebitoRef.innerHTML = `<option value="">Abater em... (selecione a dívida)</option>`;

  abertas.forEach(x => {
    const opt = document.createElement("option");
    opt.value = x.debtId;
    opt.textContent = `${x.debito.descricao} • saldo ${moeda(x.saldo)} (de ${moeda(x.debito.valor)})`;
    selDebitoRef.appendChild(opt);
  });
}

function renderExtratoDebitos(porAluno) {
  blocosDebitos.innerHTML = "";

  const alunos = [...porAluno.keys()].filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  if (alunos.length === 0) {
    blocosDebitos.innerHTML = `<div class="hint">Nenhum débito interno lançado ainda.</div>`;
    return;
  }

  for (const aluno of alunos) {
    const lista = porAluno.get(aluno) || [];
    const totalAbertoAluno = lista.reduce((acc,x)=>acc+(Number(x.saldo)||0),0);

    const wrap = document.createElement("div");
    wrap.style.border = "1px solid #2b2b2b";
    wrap.style.borderRadius = "12px";
    wrap.style.padding = "14px";
    wrap.style.marginBottom = "14px";
    wrap.style.background = "rgba(255,255,255,0.02)";

    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="font-weight:800;font-size:16px">${aluno}</div>
        <div style="font-weight:800;color:#f39c12">Saldo devedor: ${moeda(totalAbertoAluno)}</div>
      </div>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px" id="debitos-${aluno.replace(/\W+/g,'_')}"></div>
    `;

    blocosDebitos.appendChild(wrap);

    const box = wrap.querySelector(`#debitos-${aluno.replace(/\W+/g,'_')}`);

    for (const x of lista) {
      const total = Number(x.debito.valor) || 0;
      const pago = Number(x.pagoTotal) || 0;
      const saldo = Number(x.saldo) || 0;
      const pct = total > 0 ? Math.min(100, Math.round((pago/total)*100)) : 0;

      const div = document.createElement("div");
      div.style.padding = "12px";
      div.style.borderRadius = "10px";
      div.style.border = "1px solid #2b2b2b";
      div.style.background = "rgba(0,0,0,0.18)";

      const pagamentosOrdenados = [...x.pagamentos].sort((a,b)=>(a._ts||0)-(b._ts||0));

      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div style="font-weight:700">${x.debito.descricao}</div>
          <div style="display:flex;gap:14px;flex-wrap:wrap">
            <div><span class="hint">Total:</span> <b>${moeda(total)}</b></div>
            <div><span class="hint">Pago:</span> <b style="color:#2ecc71">${moeda(pago)}</b></div>
            <div><span class="hint">Saldo:</span> <b style="color:#f39c12">${moeda(saldo)}</b></div>
          </div>
        </div>

        <div style="margin-top:8px">
          <div style="height:8px;background:#1f1f1f;border:1px solid #333;border-radius:999px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:#2ecc71"></div>
          </div>
          <div class="hint" style="margin-top:6px">Progresso: ${pct}%</div>
        </div>

        <div style="margin-top:10px">
          <div class="hint" style="margin-bottom:6px">Abatimentos:</div>
          ${
            pagamentosOrdenados.length
            ? `<div style="display:flex;flex-direction:column;gap:6px">
                ${pagamentosOrdenados.map(p=>`
                  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                    <div class="hint">${p.data} • ${p.descricao || "Pagamento"}</div>
                    <div style="font-weight:800;color:#2ecc71">${moeda(p.valor)}</div>
                  </div>
                `).join("")}
               </div>`
            : `<div class="hint">Nenhum pagamento ainda.</div>`
          }
        </div>
      `;

      box.appendChild(div);
    }
  }
}

function render() {
  tabela.innerHTML = "";

  let r = 0, d = 0;

  const porAluno = getDebitosPorAluno();
  let debitoAberto = 0;
  for (const lista of porAluno.values()) {
    for (const x of lista) debitoAberto += Number(x.saldo) || 0;
  }

  const ordenado = [...dados].sort((a,b) => (b._ts||0) - (a._ts||0));
  for (const l of ordenado) {
    if (l.tipo === "receita") r += Number(l.valor) || 0;
    if (l.tipo === "despesa") d += Number(l.valor) || 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.data || ""}</td>
      <td>${l.aluno || ""}</td>
      <td>${l.descricao || ""}</td>
      <td class="right">${moeda(l.valor)}</td>
      <td>${l.tipo === "debito" ? "Débito Interno" : (l.tipo === "receita" ? "Receita" : "Despesa")}</td>
      <td>
        <div class="actions">
          <button class="a edit" data-id="${l.id}">Editar</button>
          <button class="a del" data-id="${l.id}">Excluir</button>
        </div>
      </td>
    `;
    tabela.appendChild(tr);
  }

  totalReceitas.textContent = moeda(r);
  totalDespesas.textContent = moeda(d);
  totalDebito.textContent = moeda(debitoAberto);
  saldoFinal.textContent = moeda(r - d);

  renderExtratoDebitos(porAluno);

  salvar();
  atualizarSelectAbatimento();
}

// eventos
selTipo.addEventListener("change", atualizarSelectAbatimento);
inpAluno.addEventListener("input", atualizarSelectAbatimento);

form.addEventListener("submit", (e) => {
  e.preventDefault();

  const aluno = normalizarAluno(inpAluno.value);
  const descricao = (inpDesc.value || "").trim();
  const valor = Number(inpValor.value || 0);
  const tipo = selTipo.value;

  if (!aluno || !descricao || !valor || valor <= 0) return;

  // edição simples
  if (editId) {
    const idx = dados.findIndex(x => x.id === editId);
    if (idx >= 0) {
      dados[idx].aluno = aluno;
      dados[idx].descricao = descricao;
      dados[idx].valor = valor;
      dados[idx].tipo = tipo;
    }
    editId = null;
    btnCancelar.style.display = "none";
    form.reset();
    render();
    return;
  }

  const novo = {
    id: genId(),
    _ts: Date.now(),
    data: hoje(),
    aluno,
    descricao,
    valor,
    tipo
  };

  if (tipo === "debito") {
    novo.debitoId = genId();
  }

  if (tipo === "receita") {
    const ref = wrapDebitoRef.style.display !== "none" ? (selDebitoRef.value || "") : "";
    if (ref) novo.refDebitoId = ref;
  }

  dados.push(novo);
  form.reset();
  wrapDebitoRef.style.display = "none";
  selDebitoRef.value = "";
  render();
});

tabela.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;

  const id = btn.dataset.id;
  if (!id) return;

  if (btn.classList.contains("del")) {
    if (confirm("Tem certeza que deseja excluir este lançamento?")) {
      dados = dados.filter(x => x.id !== id);
      salvar();
      render();
    }
    return;
  }

  if (btn.classList.contains("edit")) {
    const l = dados.find(x => x.id === id);
    if (!l) return;
    inpAluno.value = l.aluno || "";
    inpDesc.value = l.descricao || "";
    inpValor.value = l.valor || "";
    selTipo.value = l.tipo || "receita";
    editId = id;
    btnCancelar.style.display = "inline-block";
    atualizarSelectAbatimento();
  }
});

btnCancelar.addEventListener("click", () => {
  editId = null;
  form.reset();
  btnCancelar.style.display = "none";
  atualizarSelectAbatimento();
});

render();
  </script>
</body>
</html>
