<!doctype html>
<meta charset="utf-8">
<title>Financeiro (tabela)</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:16px;max-width:900px}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:8px}
  thead th{background:#f2f2f2} td.v{text-align:right}
</style>
<h1>Financeiro</h1>
<div>Total: <strong id="total">R$ 0,00</strong></div>
<table>
  <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th></tr></thead>
  <tbody id="tb"><tr><td colspan="4">Carregando…</td></tr></tbody>
</table>
<script>
function money(n){try{return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}catch{return 'R$ '+Number(n||0).toFixed(2)}}
function iso(d){return String(d||'').slice(0,10)}
(async()=>{
  try{
    const r=await fetch('/api/financeiro/lancamentos',{cache:'no-store'});
    const L=await r.json();
    const tb=document.getElementById('tb'); const tot=document.getElementById('total');
    if(!Array.isArray(L)||!L.length){tb.innerHTML='<tr><td colspan="4">Nenhum lançamento</td></tr>'; tot.textContent=money(0); return;}
    let t=0; tb.innerHTML=L.map(l=>{const v=Number(l.valor||0); t+=(l.tipo==='receita'?v:-v);
      return `<tr><td>${iso(l.data)}</td><td>${l.tipo}</td><td>${l.descricao??'-'}</td><td class="v">${money(v)}</td></tr>`;}).join('');
    tot.textContent=money(t);
  }catch(e){document.getElementById('tb').innerHTML='<tr><td colspan="4">Erro: '+String(e)+'</td></tr>'}
})();
</script>
