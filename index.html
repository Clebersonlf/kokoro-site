<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Kokoro - Portal de Artes Marciais" />
    <title>Kokoro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <!-- SCRIPT DO HCAPTCHA -->
    <script src="https://js.hcaptcha.com/1/api.js?onload=initCaptcha&render=explicit" async defer></script>
    <style>
        /* Estilos gerais que você já tinha */
        .auth-container{position:relative; z-index:20; display:flex; gap:8px; justify-content:flex-end; padding:8px}
        .auth-btn{background:transparent;border:1px solid #555;color:#ddd;border-radius:10px;padding:8px 12px;cursor:pointer}
        #btnLogout{display:none}
        #sessionName{margin-right:8px;color:#9ad1ff;font-size:14px}
        .modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
        .modal .modal-content{width:min(560px,92vw);background:#171717;color:#eee;border:1px solid #333;border-radius:14px;box-shadow:0 24px 64px rgba(0,0,0,.55);padding:18px}
        .modal .modal-content h2{margin:0 0 10px;color:#8ecbff}
        .modal .close{float:right;cursor:pointer;font-size:22px;color:#bbb}
        .form-group{display:flex;flex-direction:column;gap:6px;margin:8px 0}
        .form-group input{background:#232323;border:1px solid #3a3a3a;border-radius:10px;padding:11px 12px;color:#f5f5f5}
        .submit-btn{background:#3498db;border:none;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
        .submit-btn[disabled]{opacity:.6; cursor:not-allowed}
        .auth-error{display:none;background:#3b1d1d;color:#ffb3b3;border:1px solid #6c2f2f;padding:8px 10px;border-radius:8px;margin-bottom:10px}
        .password-wrapper{position:relative; display:flex; align-items:center}
        .password-wrapper input{width:100%; padding-right:44px}
        .password-toggle{position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:0; cursor:pointer; padding:6px; color:#bbb}
        .password-toggle:focus{outline:2px solid #3498db; outline-offset:2px}
        .strength-wrap{display:flex; flex-direction:column; gap:6px; margin-top:6px}
        .strength-bar{height:8px; border-radius:999px; background:#2a2a2a; overflow:hidden}
        .strength-bar > span{display:block; height:100%; width:0%; background:#ff5858; transition:width .25s ease}
        .strength-hint{font-size:12px; color:#bbb}
        .req-list{display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:12px; color:#bbb; margin-top:4px}
        .req-item{display:flex; align-items:center; gap:6px}
        .req-item i{font-size:12px}
        .ok{color:#74ff9f}
        .no{color:#ff9f9f}
        .center-content{display:flex; flex-direction:column; align-items:center; gap:12px;}
        #motivacional.motivacional-box{position: relative; display: inline-block; max-width: 260px; padding: 10px 14px; font-size: 14px; line-height: 1.35; text-align: center; background: rgba(66, 59, 59, 0.75); border: 1px solid #333; border-radius: 10px; margin: 8px auto 0;}
        #motivacional .japanese-text{ font-size: 18px; }
        #motivacional .quote-translation{ font-size: 12px; color:#d9d9d9; }
        #motivacional .close-button{position: absolute; top: 6px; right: 8px; font-size: 18px; color: #ccc; background: transparent; border: 0; cursor: pointer;}
    </style>
</head>
<body>
<div class="container">
    <!-- Auth topo direito -->
    <div class="auth-container">
        <span id="sessionName" aria-live="polite"></span>
        <button id="loginBtn" class="auth-btn" aria-label="Login">Login</button>
        <button id="registerBtn" class="auth-btn" aria-label="Cadastrar-se">Cadastre-se</button>
        <button id="btnLogout" class="auth-btn" aria-label="Sair">Sair</button>
    </div>
</div>

<!-- Conteúdo principal -->
<div class="center-content">
    <h1>KOKORO</h1>
    <div class="kanji" role="img" aria-label="Kanji Kokoro - Coração/Mente">心</div>

    <!-- Caixa motivacional -->
    <div class="motivacional-box" id="motivacional">
        <button class="close-button" id="motivacionalClose" aria-label="Fechar mensagem motivacional">×</button>
        <p>
            <span lang="ja" class="japanese-text">七転び八起き</span><br />
            <span class="quote-translation">"Caia sete vezes, levante-se oito"</span>
        </p>
    </div>
</div>

<!-- Recursos -->
<section class="features-section">
    <div class="feature-card"><h3>Treine com os Melhores</h3><p>Instrutores certificados e metodologia exclusiva</p></div>
    <div class="feature-card"><h3>Conteúdo Exclusivo</h3><p>Acesso a vídeos, apostilas e material didático</p></div>
    <div class="feature-card"><h3>Mentoria</h3><p>Mentorias presenciais ou virtuais com profissionais experientes.</p></div>
</section>

<!-- Redes Sociais -->
<div class="social-media">
    <a href="https://instagram.com/seu_perfil" target="_blank" class="social-icon" aria-label="Siga-nos no Instagram"><i class="fab fa-instagram"></i></a>
    <a href="https://facebook.com/sua_pagina" target="_blank" class="social-icon" aria-label="Curta nossa página no Facebook"><i class="fab fa-facebook"></i></a>
    <a href="https://youtube.com/seu_canal" target="_blank" class="social-icon" aria-label="Inscreva-se no YouTube"><i class="fab fa-youtube"></i></a>
    <a href="https://wa.me/seu_numero" target="_blank" class="social-icon" aria-label="Contate-nos pelo WhatsApp"><i class="fab fa-whatsapp"></i></a>
</div>

<!-- Modal de Login -->
<div id="loginModal" class="modal" role="dialog" aria-labelledby="loginTitle" aria-modal="true">
    <div class="modal-content">
        <span class="close" data-close="loginModal" aria-label="Fechar modal">&times;</span>
        <h2 id="loginTitle">Login</h2>
        <div id="loginError" class="auth-error"></div>
        <form id="loginForm" action="#" method="post" autocomplete="on">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Seu email" required />
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <div class="password-wrapper">
                    <input type="password" id="password" name="password" placeholder="Sua senha" required />
                    <button type="button" class="password-toggle" aria-label="Mostrar senha" data-target="password">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="submit-btn">Entrar</button>
        </form>
    </div>
</div>

<!-- Modal de Cadastro com hCaptcha -->
<div id="registerModal" class="modal" role="dialog" aria-labelledby="registerTitle" aria-modal="true">
    <div class="modal-content">
        <span class="close" data-close="registerModal" aria-label="Fechar modal">&times;</span>
        <h2 id="registerTitle">Cadastro</h2>
        <div id="registerError" class="auth-error"></div>
        <form id="registerForm" action="#" method="post" autocomplete="on">
            <div class="form-group">
                <label for="newName">Nome completo (opcional)</label>
                <input type="text" id="newName" name="newName" placeholder="Seu nome" />
            </div>
            <div class="form-group">
                <label for="newEmail">Email:</label>
                <input type="email" id="newEmail" name="newEmail" placeholder="Seu email" required />
            </div>
            <div class="form-group">
                <label for="newPassword">Senha:</label>
                <div class="password-wrapper">
                    <input type="password" id="newPassword" name="newPassword" placeholder="Sua senha" minlength="8" required />
                    <button type="button" class="password-toggle" aria-label="Mostrar senha" data-target="newPassword">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <!-- Medidor de força + requisitos -->
                <div class="strength-wrap" id="pwStrengthWrap">
                    <div class="strength-bar"><span id="pwBar"></span></div>
                    <div class="strength-hint" id="pwHint">Força da senha</div>
                    <div class="req-list">
                        <div class="req-item" id="reqLen"><i class="fa-solid fa-circle-xmark no"></i>Mínimo 8 caracteres</div>
                        <div class="req-item" id="reqUpper"><i class="fa-solid fa-circle-xmark no"></i>Letra maiúscula</div>
                        <div class="req-item" id="reqLower"><i class="fa-solid fa-circle-xmark no"></i>Letra minúscula</div>
                        <div class="req-item" id="reqDigit"><i class="fa-solid fa-circle-xmark no"></i>Número</div>
                        <div class="req-item" id="reqSpecial"><i class="fa-solid fa-circle-xmark no"></i>Caractere especial (!@#$...)</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="newPassword2">Confirmar senha:</label>
                <div class="password-wrapper">
                    <input type="password" id="newPassword2" name="newPassword2" placeholder="Repita a senha" minlength="8" required />
                    <button type="button" class="password-toggle" aria-label="Mostrar senha" data-target="newPassword2">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>

            <!-- WIDGET DO HCAPTCHA -->
            <div class="form-group">
                <!-- ATENÇÃO AQUI: Substitua 'SUA_SITE_KEY_AQUI' pela sua chave real do hCaptcha -->
                <div id="captchaContainer" class="h-captcha"
                     data-sitekey="SUA_SITE_KEY_AQUI"
                     data-callback="onCaptchaSuccess"
                     data-expired-callback="onCaptchaExpired"
                     data-error-callback="onCaptchaError">
                </div>
            </div>

            <button type="submit" id="registerSubmit" class="submit-btn" disabled>Cadastrar</button>
        </form>
    </div>
</div>

<!-- Navegação principal -->
<nav class="menu" role="navigation">
    <ul><!-- Links serão adicionados aqui quando necessário --></ul>
</div>

    <!-- SCRIPT UNIFICADO E CORRIGIDO COM HCAPTCHA -->
    <script>
        // ===== hCaptcha: callbacks globais =====
        let isCaptchaVerified = false;
        function onCaptchaSuccess(){ isCaptchaVerified = true;  document.dispatchEvent(new Event('captchaStateChange')); }
        function onCaptchaExpired(){ isCaptchaVerified = false; document.dispatchEvent(new Event('captchaStateChange')); }
        function onCaptchaError(){   isCaptchaVerified = false; document.dispatchEvent(new Event('captchaStateChange')); }

        // ===== App =====
        document.addEventListener('DOMContentLoaded', () => {
            // Rotas/keys
            const CADASTRO_PAGE = 'cadastro.html';
            const USERS_KEY   = 'kokoro_users';
            const SESSION_KEY = 'kokoro_session';

            // Elementos
            const loginBtn  = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('btnLogout');
            const sessionNameEl = document.getElementById('sessionName');

            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const loginForm  = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginError = document.getElementById('loginError');
            const registerError = document.getElementById('registerError');
            const registerSubmit = document.getElementById('registerSubmit');

            const pwInput   = document.getElementById('newPassword');
            const pwConfirm = document.getElementById('newPassword2');
            const pwBar   = document.getElementById('pwBar');
            const pwHint  = document.getElementById('pwHint');
            const reqLen    = document.getElementById('reqLen');
            const reqUpper  = document.getElementById('reqUpper');
            const reqLower  = document.getElementById('reqLower');
            const reqDigit  = document.getElementById('reqDigit');
            const reqSpecial= document.getElementById('reqSpecial');

            const motivacionalBox = document.getElementById('motivacional');
            const motivacionalCloseBtn = document.getElementById('motivacionalClose');

            // Storage helpers
            const loadUsers   = () => JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
            const saveUsers   = (arr) => localStorage.setItem(USERS_KEY, JSON.stringify(arr));
            const setSession  = (obj) => localStorage.setItem(SESSION_KEY, JSON.stringify(obj));
            const getSession  = () => { try { return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; } };
            const clearSession= () => localStorage.removeItem(SESSION_KEY);

            // UI por sessão
            function updateUIBySession() {
                const sess = getSession();
                const isLogged = !!sess;
                if (sessionNameEl) sessionNameEl.textContent = isLogged ? `Olá, ${sess.nome || sess.email || ''}` : '';
                if (loginBtn)    loginBtn.style.display    = isLogged ? 'none' : 'inline-block';
                if (registerBtn) registerBtn.style.display = isLogged ? 'none' : 'inline-block';
                if (logoutBtn)   logoutBtn.style.display   = isLogged ? 'inline-block' : 'none';
            }

            // Modais
            function openModal(m){ if(m){ m.style.display='flex'; } }
            function closeModal(m){
                if(!m) return;
                m.style.display='none';
                if (m.id === 'registerModal' && window.hcaptcha) {
                    try { window.hcaptcha.reset(); isCaptchaVerified = false; checkIfRegisterReady(); } catch {}
                }
            }
            [loginModal, registerModal].forEach(m => m && m.addEventListener('click', (e)=>{ if(e.target===m) closeModal(m); }));
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(loginModal); closeModal(registerModal); }});
            document.querySelectorAll('.close[data-close]').forEach(btn=>{
                btn.addEventListener('click', ()=> {
                    const id = btn.getAttribute('data-close');
                    const el = document.getElementById(id);
                    closeModal(el);
                });
            });

            // Botões topo
            registerBtn?.addEventListener('click', ()=> openModal(registerModal));
            loginBtn?.addEventListener('click',    ()=> openModal(loginModal));
            logoutBtn?.addEventListener('click',   ()=> { clearSession(); updateUIBySession(); alert('Você saiu.'); });

            // Login via API
            loginForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (loginError) loginError.style.display = 'none';
                const email = (document.getElementById('email')?.value || '').trim().toLowerCase();
                const senha = document.getElementById('password')?.value || '';

                try {
                    const resp = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json' },
                        body: JSON.stringify({ email, senha })
                    });
                    const data = await resp.json();

                    if (!data.ok) {
                        (loginError ? (loginError.textContent = data.message || 'E-mail ou senha inválidos.', loginError.style.display='block') : alert(data.message || 'E-mail ou senha inválidos.'));
                        return;
                    }

                    setSession({ id: data.user.id, email: data.user.email, nome: data.user.nome, role: data.user.role });
                    window.location.href = (data.user.role === 'admin') ? '/admin/index.html' : '/user/index.html';
                } catch {
                    (loginError ? (loginError.textContent = 'Falha ao conectar. Tente novamente.', loginError.style.display='block') : alert('Falha ao conectar. Tente novamente.'));
                }
            });

            // Regras de senha (cadastro)
            const rules = {
                len: s => s.length >= 8,
                upper: s => /[A-Z]/.test(s),
                lower: s => /[a-z]/.test(s),
                digit: s => /\d/.test(s),
                special: s => /[^A-Za-z0-9]/.test(s)
            };
            function setReq(el, ok){
                if(!el) return;
                const icon = el.querySelector('i');
                if(ok){ icon.classList.remove('fa-circle-xmark','no'); icon.classList.add('fa-circle-check','ok'); }
                else  { icon.classList.remove('fa-circle-check','ok'); icon.classList.add('fa-circle-xmark','no'); }
            }
            function checkIfRegisterReady(){
                if(!pwInput || !pwConfirm || !registerSubmit) return;
                const s = pwInput.value || '';
                let passed = 0;
                if(rules.len(s)) passed++;
                if(rules.upper(s)) passed++;
                if(rules.lower(s)) passed++;
                if(rules.digit(s)) passed++;
                if(rules.special(s)) passed++;

                const pct = [0,20,40,70,90,100][passed];
                if (pwBar)   pwBar.style.width = pct + '%';
                if (pwBar)   pwBar.style.background = passed <= 2 ? '#ff5858' : (passed === 3 ? '#ffaa3b' : '#74ff9f');
                if (pwHint)  pwHint.textContent   = passed <= 2 ? 'Senha fraca' : (passed === 3 ? 'Senha média' : 'Senha forte');

                setReq(reqLen, rules.len(s));
                setReq(reqUpper, rules.upper(s));
                setReq(reqLower, rules.lower(s));
                setReq(reqDigit, rules.digit(s));
                setReq(reqSpecial, rules.special(s));

                const allOk = passed >= 4 && pwInput.value.length >= 8 && pwInput.value === pwConfirm.value && isCaptchaVerified;
                registerSubmit.disabled = !allOk;
            }
            pwInput?.addEventListener('input', checkIfRegisterReady);
            pwConfirm?.addEventListener('input', checkIfRegisterReady);
            document.addEventListener('captchaStateChange', checkIfRegisterReady);

            // Olhinho
            function togglePasswordVisibility(btn){
                const targetId = btn.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if(!input) return;
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                btn.setAttribute('aria-label', isPassword ? 'Ocultar senha' : 'Mostrar senha');
                btn.innerHTML = isPassword ? '<i class="fa-solid fa-eye-slash"></i>' : '<i class="fa-solid fa-eye"></i>';
            }
            document.querySelectorAll('.password-toggle').forEach(btn=>{
                btn.addEventListener('click', ()=> togglePasswordVisibility(btn));
            });

            // Caixa motivacional
            function handleMotivacionalBox(){
                if(!motivacionalBox || !motivacionalCloseBtn) return;
                const KEY = 'kokoro_motivacional_last_close';
                const today = new Date().toDateString();
                const last  = localStorage.getItem(KEY);
                motivacionalBox.style.display = (last === today) ? 'none' : 'inline-block';
                motivacionalCloseBtn.addEventListener('click', ()=>{
                    motivacionalBox.style.display = 'none';
                    localStorage.setItem(KEY, today);
                });
            }

            // Init
            updateUIBySession();
            checkIfRegisterReady();
            handleMotivacionalBox();
        });
    </script>

    <!-- Se você realmente precisa desses dois scripts externos, deixe-os.
         Se eles duplicarem a lógica de login/captcha, remova-os. -->
    <script src="js/captcha.js"></script>
    <script src="/shared/js/admin-login.js?v=20250830184536"></script>
<script id="SESSIONNAME_GO_ADMIN">
document.addEventListener("DOMContentLoaded",function(){
  var el=document.getElementById("sessionName");
  if(!el) return;
  try{ var s=JSON.parse(localStorage.getItem("kokoro_session")||"null"); }catch(e){ s=null; }
  if(s){
    el.style.cursor="pointer";
    el.title="Ir ao painel administrativo";
    el.addEventListener("click",function(){ location.href="/admin/index.html"; });
  }
});
</script>
  <script src="/shared/js/auth.js"></script>
</body>
</html>
