<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Financeiro • Kokoro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:20px; color:#222; }
    h1 { margin-bottom:10px; }
    .card { background:#fff; border-radius:8px; padding:15px; margin-bottom:15px; border:1px solid #ddd; }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, select, button { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; }
    button { background:#6c5ce7; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-top:12px; }
    button:hover { opacity:0.9; }

    .row-actions { display:flex; gap:8px; margin-top:10px; }
    .row-actions button { width:auto; padding:8px 12px; margin-top:0; }
    .btn-cancel { background:#636e72; }
    .btn-edit { background:#0984e3; padding:6px 10px; border-radius:6px; }
    .btn-edit:hover { opacity:0.9; }

    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th, td { border-bottom:1px solid #ddd; padding:6px; text-align:left; vertical-align:middle; }
    th { background:#fafafa; }
    .receita { color:green; font-weight:bold; }
    .despesa { color:red; font-weight:bold; }
    .muted { color:#666; font-size:12px; margin-top:6px; }

    .editing-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:#ffeaa7;
      color:#2d3436;
      font-size:12px;
      font-weight:bold;
      margin-left:8px;
    }
  </style>
</head>

<body>
  <h1>Financeiro <span id="editingBadge" class="editing-badge" style="display:none;">EDITANDO</span></h1>

  <div class="card">
    <h2 id="formTitle">Novo lançamento</h2>

    <form id="form">
      <label>Data</label>
      <input type="date" id="data" required>

      <label>Tipo</label>
      <select id="tipo" required>
        <option value="receita">Receita</option>
        <option value="despesa">Despesa</option>
      </select>

      <label>Valor (R$)</label>
      <input type="number" id="valor" step="0.01" min="0.01" required>

      <label>Aluno ID (opcional)</label>
      <input type="text" id="aluno_id" placeholder="Cole o ID do aluno (se quiser)">

      <label>Descrição</label>
      <input type="text" id="descricao" placeholder="Ex.: Mensalidade janeiro - Aluno X">

      <div class="row-actions">
        <button id="btnSubmit" type="submit">Salvar</button>
        <button id="btnCancel" type="button" class="btn-cancel" style="display:none;">Cancelar edição</button>
      </div>

      <div class="muted">Se der erro, abra o Console (F12) e copie a primeira linha vermelha.</div>
    </form>
  </div>

  <div class="card">
    <h2>Lançamentos</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Descrição</th>
          <th style="width:120px;">Ações</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>
  </div>

<script>
  // ====== estado da tela ======
  let editingId = null; // quando não for null, estamos editando

  function formatarData(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso);
    return d.toLocaleDateString('pt-BR');
  }

  // Converte "2026-01-02T..." para "2026-01-02" no input date
  function isoToDateInput(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function setModoEdicao(on) {
    const badge = document.getElementById('editingBadge');
    const title = document.getElementById('formTitle');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnCancel = document.getElementById('btnCancel');

    if (on) {
      badge.style.display = 'inline-block';
      title.textContent = 'Editar lançamento';
      btnSubmit.textContent = 'Salvar edição';
      btnCancel.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
      title.textContent = 'Novo lançamento';
      btnSubmit.textContent = 'Salvar';
      btnCancel.style.display = 'none';
    }
  }

  function limparForm() {
    document.getElementById('data').value = '';
    document.getElementById('tipo').value = 'receita';
    document.getElementById('valor').value = '';
    document.getElementById('aluno_id').value = '';
    document.getElementById('descricao').value = '';
  }

  async function carregar() {
    const res = await fetch('/api/financeiro/lancamentos');
    const dados = await res.json();

    const tbody = document.getElementById('lista');
    tbody.innerHTML = '';

    dados.forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatarData(l.data)}</td>
        <td class="${l.tipo}">${l.tipo}</td>
        <td>R$ ${Number(l.valor).toFixed(2)}</td>
        <td>${l.descricao || ''}</td>
        <td>
          <button class="btn-edit" data-id="${l.id}">Editar</button>
        </td>
      `;

      // clique editar
      tr.querySelector('.btn-edit').addEventListener('click', () => {
        editingId = l.id;

        document.getElementById('data').value = isoToDateInput(l.data);
        document.getElementById('tipo').value = l.tipo;
        document.getElementById('valor').value = Number(l.valor);
        document.getElementById('aluno_id').value = l.aluno_id || '';
        document.getElementById('descricao').value = l.descricao || '';

        setModoEdicao(true);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      tbody.appendChild(tr);
    });
  }

  async function apiCriar(payload) {
    const res = await fetch('/api/financeiro/lancamentos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      alert('Erro ao salvar (POST). Veja o console.\n' + txt);
      return false;
    }
    return true;
  }

  async function apiEditar(id, payload) {
    const res = await fetch(`/api/financeiro/lancamentos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      alert('Erro ao salvar edição (PUT). Veja o console.\n' + txt);
      return false;
    }
    return true;
  }

  // cancelar edição
  document.getElementById('btnCancel').addEventListener('click', async () => {
    editingId = null;
    setModoEdicao(false);
    limparForm();
    await carregar();
  });

  // submit do form (criar OU editar)
  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      data: document.getElementById('data').value,
      tipo: document.getElementById('tipo').value,
      valor: document.getElementById('valor').value,
      aluno_id: document.getElementById('aluno_id').value || null,
      descricao: document.getElementById('descricao').value
    };

    let ok;
    if (editingId) {
      ok = await apiEditar(editingId, payload);
    } else {
      ok = await apiCriar(payload);
    }

    if (!ok) return;

    // reset
    editingId = null;
    setModoEdicao(false);
    limparForm();
    await carregar();
  });

  carregar();
</script>
</body>
</html>
