<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KOKORO 心 - Relatórios Financeiros</title>
  <link rel="stylesheet" href="/admin/css/linkbtn.css">
  <link rel="stylesheet" href="/admin/css/btns.css">
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="pragma" content="no-cache"/>
  <meta http-equiv="expires" content="0"/>
  <style>
    :root { --cor-fundo:#121212; --cor-container:#1a1a1a; --cor-borda:#333;
      --cor-texto-principal:#f0f0f0; --cor-azul:#3498db; }
    body{margin:0;background:var(--cor-fundo);color:var(--cor-texto-principal);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    .container{max-width:1600px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;justify-content:flex-end;padding:10px 16px}
    .btn{border:1px solid #334155;border-radius:.6rem;background:#111827;color:#bfdbfe;text-decoration:none;padding:.55rem .9rem}
    .btn:hover{border-color:#3b82f6;color:#dbeafe}
    h1{color:var(--cor-azul);text-align:center;margin:8px 0 20px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:linear-gradient(180deg,#1a1a1a,#171717);border:1px solid var(--cor-borda);border-radius:12px;padding:16px}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(3,1fr);margin:16px 0}
    .kpi{background:#181818;border:1px solid #2a2a2a;border-radius:10px;padding:14px;text-align:center}
    .kpi h3{margin:2px 0 6px;font-size:.95rem;opacity:.8}
    .kpi p{margin:0;font-weight:800;font-size:1.5rem}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 16px}
    .toolbar input,.toolbar select,.toolbar button{background:#2a2a2a;color:#fff;border:1px solid #3a3a3a;border-radius:8px;padding:10px}
    canvas{width:100%;height:320px;max-height:420px}
    .muted{opacity:.75;font-size:.9rem}
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="topbar">
  <a class="btn" href="/admin/financeiro/financeiro.html">← Voltar ao Financeiro</a>
  <a class="btn" href="/admin/index.html">Admin</a>
</nav>

<div class="container">
  <h1>Relatórios Financeiros</h1>

  <div class="toolbar">
    <select id="preset">
      <option value="30">Últimos 30 dias</option>
      <option value="90">Últimos 90 dias</option>
      <option value="365" selected>Últimos 12 meses</option>
      <option value="custom">Personalizado…</option>
    </select>
    <input type="date" id="ini" />
    <input type="date" id="fim" />
    <button id="btn-atualizar">Atualizar</button>
    <button id="btn-pdf">Gerar PDF</button>
    <button id="btn-docx" disabled>Gerar DOCX</button>
  </div>

  <div class="kpis">
    <div class="kpi"><h3>Receitas</h3><p id="kpi-receitas">R$ 0,00</p></div>
    <div class="kpi"><h3>Despesas + Repasses</h3><p id="kpi-despesas">R$ 0,00</p></div>
    <div class="kpi"><h3>Saldo</h3><p id="kpi-saldo">R$ 0,00</p></div>
  </div>

  <div class="grid">
    <div class="card"><h3>Receitas vs Despesas (Linha)</h3><canvas id="chartLinha" aria-label="Receitas vs Despesas (Linha)"></canvas></div>
    <div class="card"><h3>Composição de Receita (Pizza)</h3><canvas id="chartPizza" aria-label="Composição de Receita (Pizza)"></canvas></div>
    <div class="card"><h3>Receitas por Mês (Barras)</h3><canvas id="chartBarras" aria-label="Receitas por Mês (Barras)"></canvas></div>
    <div class="card"><h3>Despesas & Repasses por Mês (Colunas)</h3><canvas id="chartColunas" aria-label="Despesas & Repasses por Mês (Colunas)"></canvas></div>
  </div>

  <p class="muted">v2: Agora os números vêm **apenas** de <code>/api/financeiro/lancamentos</code>. Se o banco estiver vazio, tudo fica zerado.</p>
</div>

<script>
  // ======== UTIL ========
  const fmtBR = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const iso = d => String(d||'').slice(0,10);
  const monthLabel = (dt) => dt.toLocaleDateString('pt-BR',{month:'short'}).replace('.','');

  // Gera vetor de meses entre ini..fim (inclusive) para rótulos/series
  function buildMonths(iniDate, fimDate){
    const months = [];
    const d = new Date(iniDate.getFullYear(), iniDate.getMonth(), 1);
    const end = new Date(fimDate.getFullYear(), fimDate.getMonth(), 1);
    while (d <= end){
      months.push({ key: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`, label: monthLabel(d) });
      d.setMonth(d.getMonth()+1);
    }
    return months;
  }

  // ======== BUSCA DA API (SEM CACHE) ========
  async function fetchLancamentos(){
    const url = `/api/financeiro/lancamentos?t=${Date.now()}`;
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    return Array.isArray(j)? j : [];
  }

  // ======== ESTADO DOS GRÁFICOS ========
  let gLinha,gPizza,gBarras,gColunas;

  function destroyCharts(){
    [gLinha,gPizza,gBarras,gColunas].forEach(g => { try{ g && g.destroy(); }catch(e){} });
    gLinha=gPizza=gBarras=gColunas=null;
  }

  // ======== RENDER ========
  async function render(){
    // período
    const preset = document.getElementById('preset').value;
    const iniEl = document.getElementById('ini'), fimEl = document.getElementById('fim');

    let dIni, dFim;
    if (preset === 'custom' && iniEl.value && fimEl.value){
      dIni = new Date(iniEl.value + 'T00:00:00');
      dFim = new Date(fimEl.value + 'T23:59:59');
    } else {
      const dias = Number(preset)||365;
      dFim = new Date();
      dIni = new Date(Date.now() - dias*86400000);
      iniEl.disabled = true; fimEl.disabled = true;
      iniEl.valueAsDate = dIni; fimEl.valueAsDate = dFim;
    }

    // busca dados do backend
    let data = [];
    try {
      data = await fetchLancamentos();
    } catch(e){
      console.error('Falha API:', e);
      data = [];
    }

    // filtra por período (client-side)
    const iniMs = dIni.getTime(), fimMs = dFim.getTime();
    const within = (dstr) => {
      const ms = new Date(dstr || '').getTime();
      return !isNaN(ms) && ms >= iniMs && ms <= fimMs;
    };
    const rows = data.filter(l => within(l.data || l.created_at));

    // KPI totals
    let totRec = 0, totDesp = 0;
    rows.forEach(l => {
      const v = Number(l.valor || 0);
      if (l.tipo === 'receita') totRec += v; else totDesp += v;
    });
    document.getElementById('kpi-receitas').textContent = fmtBR(totRec);
    document.getElementById('kpi-despesas').textContent = fmtBR(totDesp);
    document.getElementById('kpi-saldo').textContent    = fmtBR(totRec - totDesp);

    // Se não houver dados -> tudo zerado e gráficos vazios
    destroyCharts();
    const months = buildMonths(
            new Date(dIni.getFullYear(), dIni.getMonth(), 1),
            new Date(dFim.getFullYear(), dFim.getMonth(), 1)
    );
    const mapRec = Object.fromEntries(months.map(m=>[m.key,0]));
    const mapDes = Object.fromEntries(months.map(m=>[m.key,0]));

    rows.forEach(l => {
      const d = new Date(l.data || l.created_at);
      if (isNaN(d)) return;
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const v = Number(l.valor||0);
      if (l.tipo === 'receita') mapRec[key] = (mapRec[key]||0) + v;
      else                      mapDes[key] = (mapDes[key]||0) + v;
    });

    const labels = months.map(m => m.label);
    const serieRec = months.map(m => mapRec[m.key]||0);
    const serieDes = months.map(m => mapDes[m.key]||0);

    // Pizza por "categoria" (heurística simples pela descrição)
    const comp = { Mensalidades:0, Produtos:0, Serviços:0 };
    rows.forEach(l=>{
      if (l.tipo !== 'receita') return;
      const txt = (l.descricao||'').toLowerCase();
      const v = Number(l.valor||0);
      if (txt.includes('mensal')) comp.Mensalidades += v;
      else if (txt.includes('produto')) comp.Produtos += v;
      else comp.Serviços += v;
    });

    // ==== GRÁFICOS ====
    const ctxL = document.getElementById('chartLinha');
    const ctxP = document.getElementById('chartPizza');
    const ctxB = document.getElementById('chartBarras');
    const ctxC = document.getElementById('chartColunas');

    gLinha = new Chart(ctxL, {
      type:'line',
      data:{ labels, datasets:[
          { label:'Receitas', data:serieRec },
          { label:'Despesas', data:serieDes },
        ]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    gPizza = new Chart(ctxP, {
      type:'pie',
      data:{ labels:Object.keys(comp), datasets:[{ data:Object.values(comp) }] },
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    gBarras = new Chart(ctxB, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Receitas', data:serieRec }] },
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    gColunas = new Chart(ctxC, {
      type:'bar',
      data:{ labels, datasets:[
          { label:'Despesas', data:serieDes },
          { label:'Repasses', data:months.map(()=>0) } // ainda não há "repasses" na API
        ]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });
  }

  // ======== BOTOES ========
  document.getElementById('btn-atualizar').addEventListener('click', () => render());
  document.getElementById('btn-pdf').addEventListener('click', () => window.print());

  // habilita datas quando custom
  const presetSel = document.getElementById('preset');
  const iniEl = document.getElementById('ini'), fimEl = document.getElementById('fim');
  function setPreset(){
    const v = presetSel.value;
    if(v==='custom'){ iniEl.disabled=false; fimEl.disabled=false; }
    else{
      iniEl.disabled=true; fimEl.disabled=true;
      const dias = Number(v)||365;
      const dFim = new Date(); const dIni = new Date(Date.now()-dias*86400000);
      iniEl.valueAsDate = dIni; fimEl.valueAsDate = dFim;
    }
  }
  presetSel.addEventListener('change', setPreset);

  // primeira renderização
  setPreset();
  render();
</script>
</body>
</html>
