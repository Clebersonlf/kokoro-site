<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro - Cadastro de Atleta (Versão Aurora)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- GERAL E VARIÁVEIS (TEMA AURORA BOREAL) --- */
        :root {
            --bg-main: #0d0c0f;
            --bg-card: rgba(20, 18, 23, 0.65); /* Glassmorphism Base */
            --border-color: rgba(60, 50, 70, 0.7);
            --text-primary: #f0e7ff;
            --text-muted: #a093b0;
            --primary-color: #4ade80; /* Verde Vibrante */
            --secondary-color: #38bdf8; /* Azul Ciano */
            --accent-glow: rgba(74, 222, 128, 0.3);
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);

            /* Cores para cada seção (adaptadas ao tema Aurora) */
            --section-color-1: #38bdf8; /* Azul */
            --section-color-2: #4ade80; /* Verde */
            --section-color-3: #a78bfa; /* Roxo */
            --section-color-4: #f472b6; /* Rosa */
            --section-color-5: #2dd4bf; /* Teal */
            --section-color-6: #f97316; /* Laranja para destaque do termo */


            /* Cores de classificação IMC */
            --color-normal: #22c55e;
            --color-atencao: #f59e0b; /* Laranja ainda se destaca bem */
            --color-alerta: #ef4444;  /* Vermelho ainda é universal para alerta */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes move-aurora-1 {
            0% { transform: translate(-70%, -70%) scale(1); }
            100% { transform: translate(-50%, -80%) scale(1.2); }
        }
        @keyframes move-aurora-2 {
            0% { transform: translate(20%, 20%) scale(1); }
            100% { transform: translate(40%, 10%) scale(1.3); }
        }

        /* --- ESTILOS DA PÁGINA DE CADASTRO --- */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-main);
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
        }

        body::before, body::after {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            opacity: 0.2;
            filter: blur(120px);
            z-index: -1;
            will-change: transform;
        }
        body::before {
            background: radial-gradient(circle, var(--primary-color), transparent 60%);
            transform: translate(-70%, -70%);
            animation: move-aurora-1 15s infinite alternate ease-in-out;
        }
        body::after {
            background: radial-gradient(circle, var(--secondary-color), transparent 60%);
            transform: translate(20%, 20%);
            animation: move-aurora-2 18s infinite alternate ease-in-out;
        }

        .form-wrapper {
            width: 100%;
            max-width: 900px;
            background-color: var(--bg-card);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.6s ease-out forwards;
        }

        .form-main-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 18, 23, 0.5);
        }

        .form-main-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: #fff;
            letter-spacing: -1px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .header-controls a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .header-controls a:hover {
            color: #fff;
        }

        form {
            padding: 2rem;
        }

        .form-section {
            border: none;
            padding: 0;
            margin: 0 0 2.5rem 0;
        }

        .form-section legend {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            width: 100%;
            box-sizing: border-box;
            background: rgba(0,0,0,0.2);
            border-left-width: 4px;
            border-left-style: solid;
            letter-spacing: 0.025em;
        }

        /* Cores da borda esquerda das legendas */
        .section-personal > legend { border-left-color: var(--section-color-1); }
        .section-sports > legend { border-left-color: var(--section-color-2); }
        .section-biometric > legend { border-left-color: var(--section-color-3); }
        .section-emergency > legend { border-left-color: var(--section-color-4); }
        .section-parq > legend { border-left-color: var(--section-color-5); }
        .section-parental > legend { border-left-color: var(--section-color-6); }


        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .sub-section {
            grid-column: span 2;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .sub-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.span-2 {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--color-alerta);
        }

        body.admin-mode-active .form-group label.required::after {
            content: '';
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 400;
            color: var(--text-primary);
        }

        .radio-group input[type="radio"] {
            margin-right: 0.25rem;
            accent-color: var(--primary-color);
        }


        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #100e13;
            color: var(--text-primary);
            outline: none;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
            transform: scale(1.01);
        }

        .form-group input[readonly] {
            background-color: #2D3748;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .hidden-field {
            display: none !important;
        }

        .parq-question {
            background-color: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        .parq-question p { margin: 0 0 0.5rem 0; font-size: 0.9rem; font-weight: 500;}
        .parq-question div label { margin-right: 1rem; font-size: 0.9rem; font-weight: 400; color: var(--text-muted);}
        .parq-question div input { margin-right: 0.25rem; }

        .final-section {
            border-top: 1px solid var(--border-color);
            padding-top: 2rem;
            margin-top: 1rem;
        }

        .terms-box {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-muted);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            height: 1.15rem;
            width: 1.15rem;
            margin-right: 0.75rem;
            accent-color: var(--primary-color);
            flex-shrink: 0;
            cursor: pointer;
        }
        .checkbox-group label {
            font-size: 1rem;
            color: var(--text-muted);
            margin: 0;
            font-weight: 400;
        }

        .submit-button, .modal-button, .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

        .submit-button:hover, .modal-button:hover, .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .submit-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            color: #fff;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }

        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: var(--text-muted);
            color: var(--bg-main);
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .imc-result-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            color: white;
            transition: all 0.3s ease;
        }

        .imc-result-box p { margin: 0; font-size: 0.95rem; }
        .imc-result-box p:first-child { margin-bottom: 0.5rem; }
        .imc-result-box strong { font-weight: 600; }
        .imc-normal { background-color: var(--color-normal); }
        .imc-atencao { background-color: var(--color-atencao); }
        .imc-alerta { background-color: var(--color-alerta); }

        .entidade-registro-block {
            border: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.2);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            position: relative;
        }

        .add-button {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            margin-top: 1rem;
        }

        .remove-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--color-alerta);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 24px;
            text-align: center;
        }

        .admin-mode-container { display: flex; align-items: center; gap: 0.75rem; }
        .admin-toggle-label { color: var(--text-muted); font-weight: 500; font-size: 0.9rem; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .admin-banner { width: 100%; background-color: var(--color-atencao); color: #fff; text-align: center; padding: 0.75rem; box-sizing: border-box; position: fixed; top: 0; left: 0; z-index: 1000; }
        .admin-banner strong { color: var(--bg-main); }
        body.admin-mode-active { padding-top: 5rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--bg-card); padding: 2rem; border-radius: var(--radius); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .modal-content h2 { margin-top: 0; color: var(--text-primary); }
        .modal-content p { color: var(--text-muted); line-height: 1.6; }
        .modal-icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; }
        .modal-button { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #fff; }
        .modal-button-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); margin-top: 1rem; }
        .modal-button-secondary:hover { background-color: rgba(60, 50, 70, 0.4); color: var(--text-primary); }
        #adminPasswordError { color: var(--color-alerta); font-size: 0.9rem; margin-top: 1rem; height: 1.2em; }

        /* ESTILOS DA FOTO DE PERFIL */
        .photo-container { width: 100%; max-width: 500px; margin: 0 auto; }
        .preview-area { width: 100%; height: 250px; border: 2px dashed var(--border-color); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); border-radius: 12px; transition: border-color 0.2s; }
        .preview-area:hover { border-color: var(--primary-color); }
        .preview-area video, .preview-area img { max-width: 100%; max-height: 100%; }
        .button-area { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
        .btn:hover { background: rgba(60, 50, 70, 0.4); color: var(--text-primary); border-color: var(--text-muted); }
        .btn.success { background-color: var(--color-normal); color: white; border: none; }

        /* ESTILOS DO TERMO DE MENOR */
        .responsible-person-notice {
            background-color: rgba(249, 115, 22, 0.1);
            border-left: 4px solid var(--section-color-6);
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }
        .responsible-person-notice p {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .termo-texto {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }
        .termo-texto ul {
            list-style-position: inside;
            padding-left: 0;
            list-style-type: none;
        }
        .termo-texto li {
            margin-bottom: 0.5rem;
        }


        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .grid-container { grid-template-columns: 1fr; }
            .form-group.span-2 { grid-column: span 1; }
            body { padding: 1rem; }
            body.admin-mode-active { padding-top: 6rem; }
            .form-wrapper { padding: 0; }
            .form-main-header { padding: 1rem; flex-direction: column; gap: 1rem; align-items: flex-start; }
            form { padding: 1rem; }
            .sub-section { grid-column: span 1; }
        }
    </style>
</head>
<body class="form-body">

<div id="adminBanner" class="admin-banner hidden-field" role="alert">
    <strong>Modo Desenvolvedor Ativado:</strong> Campos obrigatórios foram desabilitados.
</div>

<main class="form-wrapper">
    <header class="form-main-header">
        <h1>Cadastro</h1>
        <div class="header-controls">
            <a href="/">Voltar ao Início</a>
            <div class="admin-mode-container">
                <label for="adminToggle" class="admin-toggle-label">Admin</label>
                <label class="switch">
                    <input type="checkbox" id="adminToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </header>

    <form id="registerForm" action="/cadastro" method="post" novalidate>
        <fieldset class="form-section section-personal">
            <legend>Dados Pessoais</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="nomeCompleto">Nome</label>
                    <input type="text" id="nomeCompleto" name="nomeCompleto" required>
                </div>
                <div class="form-group">
                    <label class="required">Sexo</label>
                    <div class="radio-group" style="display: flex; gap: 20px; margin-top: 8px;">
                        <label for="sexoMasc">
                            <input type="radio" id="sexoMasc" name="sexo" value="masculino" required>
                            <span>Masculino</span>
                        </label>
                        <label for="sexoFem">
                            <input type="radio" id="sexoFem" name="sexo" value="feminino" required>
                            <span>Feminino</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="required" for="nomeMae">Mãe</label>
                    <input type="text" id="nomeMae" name="nomeMae" required>
                </div>
                <div class="form-group">
                    <label class="required" for="nomePai">Pai</label>
                    <input type="text" id="nomePai" name="nomePai" required>
                </div>
                <div class="form-group">
                    <label class="required" for="rg">RG</label>
                    <input type="text" id="rg" name="rg" required>
                </div>
                <div class="form-group">
                    <label class="required" for="cpf">CPF</label>
                    <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00" maxlength="14">
                    <small id="cpfErro" class="erro-campo" style="margin-top: 8px; display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="required" for="dataNascimento">Data de Nascimento</label>
                    <input type="date" id="dataNascimento" name="dataNascimento" required>
                </div>
                <div class="form-group">
                    <label for="idade">Idade</label>
                    <input type="text" id="idade" name="idade" readonly>
                </div>
                <div class="form-group span-2">
                    <label class="required" for="endereco">Endereço</label>
                    <input type="text" id="endereco" name="endereco" required>
                </div>
                <div class="form-group span-2">
                    <label for="complemento">Complemento</label>
                    <input type="text" id="complemento" name="complemento">
                </div>
                <div class="form-group">
                    <label class="required" for="bairro">Bairro</label>
                    <input type="text" id="bairro" name="bairro" required>
                </div>
                <div class="form-group">
                    <label class="required" for="cep">CEP</label>
                    <input type="text" id="cep" name="cep" required placeholder="00000-000" maxlength="9">
                </div>
                <div class="form-group span-2">
                    <label for="referencia">Referência</label>
                    <input type="text" id="referencia" name="referencia">
                </div>
                <div class="form-group">
                    <label class="required" for="telefone">Telefone</label>
                    <input type="tel" id="telefone" name="telefone" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
                <div class="form-group">
                    <label class="required" for="whatsapp">WhatsApp / Telegram</label>
                    <input type="tel" id="whatsapp" name="whatsapp" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
                <div class="form-group span-2">
                    <label class="required" for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group span-2">
                    <label>Foto de Perfil</label>
                    <div class="photo-container">
                        <div class="preview-area">
                            <img id="previewImage" src="" alt="Pré-visualização da foto" style="display: none;">
                            <video id="cameraPreview" style="display: none;" autoplay playsinline></video>
                            <input type="hidden" id="selfiePath">
                        </div>
                        <div class="button-area">
                            <label for="fileInput" class="btn">Escolher Arquivo</label>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            <button type="button" id="cameraButton" class="btn">Abrir Câmera</button>
                            <button type="button" id="captureButton" class="btn" style="display: none;">Tirar Foto</button>
                            <button type="button" id="photoSubmitButton" class="btn" style="display: none;">
                                Confirmar Foto
                            </button>
                            <button type="button" id="retakeButton" class="btn" style="display: none;">Refazer Foto</button>
                            <button type="button" id="cropButton" class="btn" style="display: none;">Recortar Foto</button>

                            <!-- Canvas que usaremos para recorte (fica escondido por enquanto) -->
                            <canvas id="cropCanvas" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset id="termoMenorIdade" class="form-section section-parental hidden-field">
            <legend>🛡️ Termo de Autorização para Menores</legend>
            <div class="responsible-person-notice">
                <p><strong>Atenção:</strong> Como o atleta é menor de 18 anos, o cadastro deve ser preenchido e autorizado pelo seu responsável legal.</p>
            </div>

            <h3 class="sub-section-title">TERMO DE AUTORIZAÇÃO PARA PRÁTICA ESPORTIVA – JIU-JITSU</h3>

            <div class="grid-container">
                <div class="form-group span-2">
                    <label for="responsavel_nome" class="required">Eu, (nome completo do responsável)</label>
                    <input type="text" id="responsavel_nome" name="responsavel_nome" placeholder="Nome completo do responsável" required>
                </div>
                <div class="form-group">
                    <label for="responsavel_rg" class="required">RG do Responsável</label>
                    <input type="text" id="responsavel_rg" name="responsavel_rg" required>
                </div>
                <div class="form-group">
                    <label for="responsavel_cpf" class="required">CPF do Responsável</label>
                    <input type="text" id="responsavel_cpf" name="responsavel_cpf" placeholder="000.000.000-00" maxlength="14" required>
                </div>
                <div class="form-group span-2">
                    <label class="required">Grau de Parentesco:</label>
                    <div class="radio-group" style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 8px;">
                        <label><input type="radio" name="grau_parentesco" value="Pai" required> Pai</label>
                        <label><input type="radio" name="grau_parentesco" value="Mãe"> Mãe</label>
                        <label><input type="radio" name="grau_parentesco" value="Avô"> Avô</label>
                        <label><input type="radio" name="grau_parentesco" value="Avó"> Avó</label>
                        <label><input type="radio" name="grau_parentesco" value="Outros"> Outros</label>
                    </div>
                </div>
                <div class="form-group span-2 hidden-field" id="outroParentescoContainer">
                    <label for="outro_parentesco_texto" class="required">Especifique o grau de parentesco:</label>
                    <input type="text" id="outro_parentesco_texto" name="outro_parentesco_texto">
                </div>
            </div>

            <p class="termo-texto">responsável legal pelo(a) menor:</p>

            <div class="grid-container">
                <div class="form-group span-2">
                    <label>Nome completo do aluno:</label>
                    <input type="text" name="menor_nome_completo">
                </div>
            </div>

            <div class="termo-texto">
                <p>Autorizo a participação do(a) menor em aulas e treinamentos de Jiu-Jitsu nas modalidades:</p>
                <ul>
                    <li>Jiu-Jitsu Tradicional, Jiu-Jitsu Competidor, Jiu-Jitsu Militar, Submission, Autodefesa, Atemi</li>
                </ul>
                <p>Declaro estar ciente de que se trata de um esporte de contato com riscos reais à integridade física, incluindo torções, quedas, contusões e, eventualmente, lesões mais graves. Estou ciente também de que a prática será acompanhada por profissionais habilitados, mas que tais riscos são inerentes à natureza do esporte.</p>
            </div>

            <h3 class="sub-section-title">✅ Responsabilidade e dever de informação</h3>
            <div class="termo-texto">
                <p>Assumo total responsabilidade quanto:</p>
                <ul>
                    <li>À condição física e psicológica do(a) menor para a prática esportiva;</li>
                    <li>À realização de exames médicos periódicos por minha conta;</li>
                    <li>Ao dever de comunicar previamente ao professor ou responsável qualquer condição de saúde relevante (doenças, moléstias, lesões anteriores, histórico clínico ou limitações físicas);</li>
                    <li>À comunicação imediata de sintomas ou situações que surgirem durante os treinos.</li>
                </ul>
            </div>

            <h3 class="sub-section-title">💊 Declaração sobre uso de substâncias</h3>
            <div class="termo-texto">
                <p>Declaro que o(a) menor:</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="substancias_nao" name="substancias_nao" required>
                <label for="substancias_nao">Não faz uso de substâncias tóxicas, entorpecentes, psicoativas ou psicotrópicas.</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="medicamentos_nao" name="medicamentos_nao" required>
                <label for="medicamentos_nao">Não utiliza medicamentos que alterem o estado físico ou mental.</label>
            </div>
            <p class="termo-texto">Se SIM para medicamentos, preencha abaixo:</p>
            <div class="grid-container">
                <div class="form-group span-2">
                    <label>Nome do(s) medicamento(s):</label>
                    <input type="text" name="medicamento_nome_menor">
                </div>
                <div class="form-group span-2">
                    <label>Finalidade/Motivo do uso:</label>
                    <input type="text" name="medicamento_motivo_menor">
                </div>
                <div class="form-group">
                    <label>Uso contínuo?</label>
                    <div class="radio-group" style="display: flex; gap: 20px;">
                        <label><input type="radio" name="medicamento_continuo_menor" value="sim"> Sim</label>
                        <label><input type="radio" name="medicamento_continuo_menor" value="nao"> Não</label>
                    </div>
                </div>
            </div>

            <h3 class="sub-section-title">🚑 Emergências médicas</h3>
            <div class="termo-texto">
                <p>Autorizo, em caso de acidentes ou episódios graves, que o(a) menor receba atendimento médico imediato, podendo ser removido(a) para unidade de saúde (hospital, pronto-socorro, etc.), inclusive com auxílio de ambulância, SAMU ou Corpo de Bombeiros, na ausência ou até a chegada do responsável legal.</p>
            </div>

            <h3 class="sub-section-title">📸 Uso de imagem</h3>
            <div class="termo-texto">
                <p>Autorizo o uso de imagens e vídeos do(a) menor durante treinos, aulas, competições ou eventos internos, para fins institucionais e promocionais da academia, em mídias como redes sociais, jornais, sites, revistas, cartazes, folders, panfletos ou banners, sem fins lucrativos e sem necessidade de nova autorização ou compensação financeira.</p>
            </div>

            <h3 class="sub-section-title">📋 Compromisso de conduta</h3>
            <div class="termo-texto">
                <p>Comprometo-me a orientar o(a) menor a:</p>
                <ul>
                    <li>✔️ Respeitar o professor e colegas de treino</li>
                    <li>✔️ Cumprir todas as orientações durante as aulas</li>
                    <li>✔️ Não executar técnicas sem supervisão do professor</li>
                    <li>✔️ Não usar as técnicas fora da academia, exceto em legítima defesa, conforme a lei</li>
                    <li>✔️ Manter conduta respeitosa (sem palavrões ou agressividade verbal)</li>
                </ul>
            </div>

            <h3 class="sub-section-title">Assinatura do Responsável</h3>
            <div class="grid-container">
                <div class="form-group">
                    <label for="responsavel_cidade" class="required">Cidade:</label>
                    <input type="text" id="responsavel_cidade" name="responsavel_cidade" required>
                </div>
                <div class="form-group">
                    <label for="responsavel_data" class="required">Data:</label>
                    <input type="date" id="responsavel_data" name="responsavel_data" required>
                </div>
                <div class="form-group">
                    <label class="required" for="responsavel_telefone">Telefone para contato:</label>
                    <input type="tel" id="responsavel_telefone" name="responsavel_telefone" placeholder="(00) 00000-0000" maxlength="15" required>
                </div>
                <div class="form-group">
                    <label for="responsavel_email">E-mail (opcional):</label>
                    <input type="email" id="responsavel_email" name="responsavel_email">
                </div>
                <div class="form-group span-2">
                    <div class="checkbox-group">
                        <input type="checkbox" id="responsavel_assinatura_check" name="responsavel_assinatura_check" required>
                        <label for="responsavel_assinatura_check" class="required">Ao marcar esta caixa, declaro que li e concordo com todos os termos acima e assino digitalmente este documento em nome do responsável legal.</label>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-sports">
            <legend>Dados Esportivos</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="arteMarcial">Qual esporte</label>
                    <select id="arteMarcial" name="arteMarcial" required>
                        <option value="">Selecione</option>
                        <option value="jiu-jitsu">Jiu-Jitsu</option>
                        <option value="judo">Judô</option>
                        <option value="karate">Karatê</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required" for="corFaixa">Cor da Faixa</label>
                    <select id="corFaixa" name="corFaixa" required disabled>
                        <option value="">Selecione o esporte primeiro</option>
                    </select>
                </div>

                <div id="nivelFaixaBrancaContainer" class="form-group span-2 hidden-field">
                    <label class="required" for="nivelFaixaBranca">Qual seu nível de experiência?</label>
                    <select id="nivelFaixaBranca" name="nivelFaixaBranca">
                        <option value="iniciante-absoluto">Iniciante absoluto (nunca treinei)</option>
                        <option value="iniciante-ja-treinei">Iniciante (já treinei antes)</option>
                    </select>
                </div>

                <div id="detalhesGraduacao" class="sub-section hidden-field">
                    <h3 class="sub-section-title">Detalhes da Graduação</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label class="required" for="anoGraduacao">Ano da última graduação</label>
                            <input type="number" id="anoGraduacao" name="anoGraduacao" placeholder="Ex: 2023">
                        </div>
                        <div id="grauContainer" class="form-group">
                            <label for="grau">Grau(s) na faixa</label>
                            <select id="grau" name="grau"></select>
                        </div>
                        <div class="form-group span-2">
                            <label for="nomeEquipe">Nome da equipe que pertencia</label>
                            <input type="text" id="nomeEquipe" name="nomeEquipe">
                        </div>
                        <div class="form-group">
                            <label for="nomeProfessor">Nome do professor</label>
                            <input type="text" id="nomeProfessor" name="nomeProfessor">
                        </div>
                        <div class="form-group">
                            <label class="required" for="graduacaoProfessor">Graduação do Professor</label>
                            <input type="text" id="graduacaoProfessor" name="graduacaoProfessor" placeholder="Ex: Faixa Preta 4º Grau" required>
                        </div>
                    </div>
                </div>

                <div id="registrosEntidades" class="sub-section hidden-field">
                    <h3 class="sub-section-title">Registros em Entidades Anteriores</h3>
                    <div id="registrosContainer"></div>
                    <button type="button" id="addEntidadeBtn" class="add-button">+ Adicionar Registro</button>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-biometric">
            <legend>Dados Biométricos</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="peso">Peso (kg)</label>
                    <input type="text" id="peso" name="peso" required placeholder="Ex: 75,5">
                </div>
                <div class="form-group">
                    <label class="required" for="altura">Altura (m)</label>
                    <input type="text" id="altura" name="altura" required placeholder="Ex: 1,80">
                </div>
                <div class="form-group span-2">
                    <div class="label-with-tooltip">
                        <label for="imc">IMC</label>
                        <button type="button" id="imcInfoIcon" class="tooltip-icon" aria-label="Mais informações sobre IMC">?</button>
                    </div>
                    <input type="text" id="imc" name="imc" readonly placeholder="Automático">
                </div>
                <div id="imcResult" class="form-group span-2 hidden-field">
                    <div class="imc-result-box" role="alert">
                        <p><strong>Classificação:</strong> <span id="imcClassification"></span></p>
                        <p><strong>Risco de Comorbidades:</strong> <span id="imcRisk"></span></p>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-emergency">
            <legend>Contato de Emergência</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="contato1_nome">Nome</label>
                    <input type="text" id="contato1_nome" name="contato1_nome" required>
                </div>
                <div class="form-group">
                    <label class="required" for="contato1_parentesco">Grau de parentesco</label>
                    <input type="text" id="contato1_parentesco" name="contato1_parentesco" required>
                </div>
                <div class="form-group span-2">
                    <label for="contato1_endereco">Endereço</label>
                    <input type="text" id="contato1_endereco" name="contato1_endereco">
                </div>
                <div class="form-group span-2">
                    <label class="required" for="contato1_telefone">Telefone</label>
                    <input type="tel" id="contato1_telefone" name="contato1_telefone" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-parq">
            <legend>Questionário de Prontidão para Atividade Física (PAR-Q)</legend>
            <div class="parq-question">
                <p>1. Algum médico já lhe disse que você possui algum problema de coração e que só deveria realizar atividade física supervisionado por profissionais de saúde?</p>
                <div>
                    <input type="radio" id="parq1_sim" name="parq1" value="sim" required><label for="parq1_sim">Sim</label>
                    <input type="radio" id="parq1_nao" name="parq1" value="nao"><label for="parq1_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>2. Você sente dores no peito quando pratica atividade física?</p>
                <div>
                    <input type="radio" id="parq2_sim" name="parq2" value="sim" required><label for="parq2_sim">Sim</label>
                    <input type="radio" id="parq2_nao" name="parq2" value="nao"><label for="parq2_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>3. No último mês, você sentiu dores no peito mesmo sem ter praticado atividade física?</p>
                <div>
                    <input type="radio" id="parq3_sim" name="parq3" value="sim" required><label for="parq3_sim">Sim</label>
                    <input type="radio" id="parq3_nao" name="parq3" value="nao"><label for="parq3_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>4. Você apresenta desequilíbrio devido a tontura e/ou já teve alguma perda de consciência?</p>
                <div>
                    <input type="radio" id="parq4_sim" name="parq4" value="sim" required><label for="parq4_sim">Sim</label>
                    <input type="radio" id="parq4_nao" name="parq4" value="nao"><label for="parq4_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>5. Você possui algum problema ósseo ou articular que poderia ser agravado pela atividade física?</p>
                <div>
                    <input type="radio" id="parq5_sim" name="parq5" value="sim" required><label for="parq5_sim">Sim</label>
                    <input type="radio" id="parq5_nao" name="parq5" value="nao"><label for="parq5_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>6. Você toma atualmente algum medicamento para pressão arterial ou coração?</p>
                <div>
                    <input type="radio" id="parq6_sim" name="parq6" value="sim" required><label for="parq6_sim">Sim</label>
                    <input type="radio" id="parq6_nao" name="parq6" value="nao"><label for="parq6_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>7. Você sabe de alguma outra razão pela qual não deveria praticar atividade física?</p>
                <div>
                    <input type="radio" id="parq7_sim" name="parq7" value="sim" required><label for="parq7_sim">Sim</label>
                    <input type="radio" id="parq7_nao" name="parq7" value="nao"><label for="parq7_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>8. Você faz uso de algum medicamento de uso contínuo ou controlado?</p>
                <div>
                    <input type="radio" id="medicamento_sim" name="medicamento" value="sim" required><label for="medicamento_sim">Sim</label>
                    <input type="radio" id="medicamento_nao" name="medicamento" value="nao"><label for="medicamento_nao">Não</label>
                </div>
            </div>
            <div id="medicamentoDescricaoContainer" class="form-group span-2 hidden-field">
                <label class="required" for="medicamentoDescricao">Por favor, descreva quais medicamentos você utiliza:</label>
                <textarea id="medicamentoDescricao" name="medicamentoDescricao"></textarea>
            </div>
        </fieldset>

        <div class="final-section">
            <div class="terms-box" tabindex="0">
                <strong>Termos e Condições de Uso e Responsabilidade</strong><br>
                <ol>
                    <li><strong>Veracidade das Informações:</strong> Você declara que todas as informações fornecidas neste formulário são verdadeiras, completas e precisas.</li>
                    <li><strong>Recomendação Médica:</strong> Você reconhece que, se respondeu "Sim" a qualquer uma das perguntas do PAR-Q, é altamente recomendável consultar um médico antes de iniciar ou aumentar a intensidade de qualquer atividade física.</li>
                    <li><strong>Assunção de Risco:</strong> Você compreende e aceita que a prática de artes marciais e atividades físicas relacionadas envolve riscos inerentes de lesões. Você assume voluntariamente todos os riscos associados à sua participação.</li>
                    <li><strong>Isenção de Responsabilidade:</strong> Você isenta o portal Kokoro, seus instrutores, administradores e parceiros de qualquer responsabilidade por lesões, danos ou perdas que possam ocorrer como resultado de sua participação.</li>
                    <li><strong>Uso de Dados (LGPD):</strong> Você autoriza o portal Kokoro a coletar e utilizar seus dados para fins de gestão de cadastro, comunicação e emergência, em conformidade com a Lei Geral de Proteção de Dados (LGPD).</li>
                </ol>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="dadosVerdadeiros" name="dadosVerdadeiros" required>
                <label for="dadosVerdadeiros">Declaro que os dados fornecidos são verdadeiros e estou ciente das responsabilidades legais.</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="aceitoTermos" name="aceitoTermos" required>
                <label for="aceitoTermos">Li e aceito os termos e condições.</label>
            </div>
            <button type="submit" class="submit-button">Cadastrar</button>
        </div>
    </form>
</main>

<template id="entidadeTemplate">
    <div class="entidade-registro-block">
        <button type="button" class="remove-button" aria-label="Remover este registro">&times;</button>
        <div class="grid-container">
            <div class="form-group span-2">
                <label class="required" for="entidadeNome">Nome da Entidade</label>
                <input type="text" name="entidadeNome[]" id="entidadeNome" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeSigla">Sigla</label>
                <input type="text" name="entidadeSigla[]" id="entidadeSigla" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeRegistro">Nº de Registro</label>
                <input type="text" name="entidadeRegistro[]" id="entidadeRegistro" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeEstado">Estado</label>
                <input type="text" name="entidadeEstado[]" id="entidadeEstado" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadePais">País</label>
                <input type="text" name="entidadePais[]" id="entidadePais" required>
            </div>
            <div class="form-group span-2">
                <label for="entidadeSite">Link (Site) da Entidade</label>
                <input type="text" name="entidadeSite[]" id="entidadeSite">
            </div>
            <div class="form-group">
                <label for="entidadeTelefone">Telefone</label>
                <input type="tel" name="entidadeTelefone[]" id="entidadeTelefone" class="masked-phone" placeholder="(00) 00000-0000" maxlength="15">
            </div>
            <div class="form-group">
                <label for="entidadeEmail">Email</label>
                <input type="email" name="entidadeEmail[]" id="entidadeEmail">
            </div>
            <div class="form-group span-2">
                <label class="required">Está ativo nesta entidade?</label>
                <div class="radio-group">
                    <input type="radio" name="entidadeAtivo" value="sim" id="entidadeAtivo_sim" required><label for="entidadeAtivo_sim">Sim</label>
                    <input type="radio" name="entidadeAtivo" value="nao" id="entidadeAtivo_nao"><label for="entidadeAtivo_nao">Não</label>
                </div>
            </div>
        </div>
    </div>
</template>

<div id="adminPasswordModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
        <h2 id="adminModalTitle">Acesso Restrito</h2>
        <p><strong>Aviso:</strong> Esta funcionalidade é para desenvolvimento. A senha é visível no código-fonte. <strong>Não use em produção.</strong></p>
        <div class="form-group">
            <label for="adminPassword" style="text-align: left;">Senha</label>
            <input type="password" id="adminPassword">
        </div>
        <div id="adminPasswordError"></div>
        <button id="adminPasswordConfirm" class="modal-button">Confirmar</button>
        <button id="adminPasswordCancel" class="modal-button modal-button-secondary">Cancelar</button>
    </div>
</div>

<div id="successModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="successModalTitle">
        <div class="modal-icon">&#10004;</div>
        <h2 id="successModalTitle">Cadastro Realizado!</h2>
        <p>Seu cadastro foi enviado com sucesso. Bem-vindo à plataforma Kokoro!</p>
        <button id="successModalClose" class="modal-button">Fechar</button>
    </div>
</div>

<div id="imcInfoModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="imcInfoModalTitle">
        <h2 id="imcInfoModalTitle">O que é o IMC?</h2>
        <p>O Índice de Massa Corporal (IMC) é uma medida simples e amplamente utilizada para avaliar o estado nutricional de uma pessoa, calculado pela fórmula: IMC = peso / (altura²).</p>
        <button id="imcInfoClose" class="modal-button">Entendi</button>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('registerForm');
        const body = document.body;
        if (!form) return;

        // --- BANCO DE DADOS DAS GRADUAÇÕES ---
        const graduacoes = {
            'jiu-jitsu': ['Faixa Branca', 'Faixa Cinza e Branca', 'Faixa Cinza', 'Faixa Cinza e Preta', 'Faixa Amarela e Branca', 'Faixa Amarela', 'Faixa Amarela e Preta', 'Faixa Laranja e Branca', 'Faixa Laranja', 'Faixa Laranja e Preta', 'Faixa Verde e Branca', 'Faixa Verde', 'Faixa Verde e Preta', 'Faixa Azul', 'Faixa Roxa', 'Faixa Marrom', 'Faixa Preta', 'Faixa Vermelha e Preta – 7º Grau', 'Faixa Vermelha e Branca – 8º Grau', 'Faixa Vermelha – 9º Grau', 'Faixa Vermelha – 10º Grau'],
            'judo': ['Faixa Branca – 6º kyū', 'Faixa Cinza ou Azul-Clara – 5º kyū', 'Faixa Laranja – 4º kyū', 'Faixa Verde – 3º kyū', 'Faixa Azul – 2º kyū', 'Faixa Marrom – 1º kyū', 'Faixa Preta – 1º dan', 'Faixa Preta – 2º dan', 'Faixa Preta – 3º dan', 'Faixa Preta – 4º dan', 'Faixa Preta – 5º dan', 'Faixa Vermelha e Preta – 6º dan', 'Faixa Vermelha e Preta – 7º dan', 'Faixa Vermelha – 8º dan', 'Faixa Vermelha – 9º dan', 'Faixa Vermelha – 10º dan'],
            'karate': ['Faixa Branca – 9º kyū', 'Faixa Amarela – 8º kyū', 'Faixa Laranja – 7º kyū', 'Faixa Verde – 6º kyū', 'Faixa Azul – 5º kyū', 'Faixa Azul (escuro) – 4º kyū', 'Faixa Marrom (1º nível) – 3º kyū', 'Faixa Marrom (2º nível) – 2º kyū', 'Faixa Marrom (3º nível) – 1º kyū', 'Faixa Preta – 1º dan', 'Faixa Preta – 2º dan', 'Faixa Preta – 3º dan', 'Faixa Preta – 4º dan', 'Faixa Preta – 5º dan', 'Faixa Coral – 6º dan', 'Faixa Coral – 7º dan', 'Faixa Vermelha e Branca – 8º dan', 'Faixa Vermelha – 9º dan', 'Faixa Vermelha – 10º dan']
        };
        const grausJiuJitsuBasico = ['Lisa', '1º Grau', '2º Grau', '3º Grau', '4º Grau'];
        const grausJiuJitsuPreta = ['Lisa', '1º Grau', '2º Grau', '3º Grau', '4º Grau', '5º Grau', '6º Grau'];

        // --- ELEMENTOS DO DOM ---
        const allRequiredFields = Array.from(form.querySelectorAll('[required]'));
        const arteMarcialSelect = document.getElementById("arteMarcial");
        const corFaixaSelect = document.getElementById("corFaixa");
        const nivelFaixaBrancaContainer = document.getElementById('nivelFaixaBrancaContainer');
        const nivelFaixaBrancaSelect = document.getElementById('nivelFaixaBranca');
        const detalhesGraduacaoDiv = document.getElementById('detalhesGraduacao');
        const grauContainer = document.getElementById('grauContainer');
        const grauSelect = document.getElementById('grau');
        const registrosEntidadesDiv = document.getElementById('registrosEntidades');
        const addEntidadeBtn = document.getElementById('addEntidadeBtn');
        const registrosContainer = document.getElementById('registrosContainer');
        const medicamentoRadios = document.querySelectorAll('input[name="medicamento"]');
        const medicamentoDescricaoContainer = document.getElementById('medicamentoDescricaoContainer');

        // --- VARIÁVEIS DE ESTADO ---
        let entidadeCounter = 0; // MELHORIA: Contador para IDs únicos nos blocos de entidade
        let stream = null;
        let currentPhoto = null;

        // ===================================================================
        // MELHORIA: LÓGICA DE MODAIS REATORADA E ACESSÍVEL
        // ===================================================================
        function setupModal(modalId, openTriggerId, closeTriggerId) {
            const modal = document.getElementById(modalId);
            const openTrigger = document.getElementById(openTriggerId);
            const closeTrigger = document.getElementById(closeTriggerId);

            if (!modal) return;

            const openModal = () => {
                modal.classList.remove('hidden-field');
                body.style.overflow = 'hidden'; // Impede o scroll do fundo
                modal.querySelector('button, input, select, textarea').focus(); // Foco no primeiro elemento interativo
            };

            const closeModal = () => {
                modal.classList.add('hidden-field');
                body.style.overflow = '';
                if(openTrigger) openTrigger.focus(); // Retorna o foco ao botão que abriu
            };

            if (openTrigger) {
                openTrigger.addEventListener('click', openModal);
            }

            if (closeTrigger) {
                closeTrigger.addEventListener('click', closeModal);
            }

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(); // Fecha se clicar no overlay
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden-field')) {
                    closeModal();
                }
            });

            // Retorna as funções para controle externo se necessário
            return { openModal, closeModal };
        }

        const successModal = setupModal('successModal', null, 'successModalClose');
        const imcInfoModal = setupModal('imcInfoModal', 'imcInfoIcon', 'imcInfoClose');

        // ===================================================================
        // MELHORIA: LÓGICA DE MODO ADMIN COM AVISOS DE SEGURANÇA
        // ===================================================================
        const adminToggle = document.getElementById('adminToggle');
        const adminBanner = document.getElementById('adminBanner');
        const adminPasswordModalEl = document.getElementById('adminPasswordModal');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminPasswordConfirmBtn = document.getElementById('adminPasswordConfirm');
        const adminPasswordCancelBtn = document.getElementById('adminPasswordCancel');
        const adminPasswordError = document.getElementById('adminPasswordError');

        const closeAdminModal = () => {
            adminPasswordModalEl.classList.add('hidden-field');
            if (!body.classList.contains('admin-mode-active')) {
                adminToggle.checked = false;
            }
            adminPasswordInput.value = '';
            adminPasswordError.textContent = '';
        }

        adminToggle.addEventListener('change', function() {
            if (this.checked) {
                adminPasswordModalEl.classList.remove('hidden-field');
                adminPasswordInput.focus();
            } else {
                // Desativar modo admin
                adminBanner.classList.add('hidden-field');
                body.classList.remove('admin-mode-active');
                allRequiredFields.forEach(field => field.setAttribute('required', 'required'));
            }
        });

        adminPasswordConfirmBtn.addEventListener('click', function() {
            // AVISO DE SEGURANÇA: Esta validação é insegura e apenas para fins de
            // prototipagem. Em um ambiente de produção, a senha deve ser validada
            // no servidor.
            if (adminPasswordInput.value === 'kokoroadmin') {
                adminBanner.classList.remove('hidden-field');
                body.classList.add('admin-mode-active');
                allRequiredFields.forEach(field => field.removeAttribute('required'));
                closeAdminModal();
            } else {
                adminPasswordError.textContent = 'Senha incorreta.';
                adminPasswordInput.focus();
            }
        });

        adminPasswordCancelBtn.addEventListener('click', closeAdminModal);
        adminPasswordModalEl.addEventListener('click', (e) => { if (e.target === adminPasswordModalEl) closeAdminModal(); });


        // ===================================================================
        // MELHORIA: MÁSCARAS DE INPUT PARA CPF, CEP E TELEFONE
        // ===================================================================
        const applyMask = (element, maskFunction) => {
            element.addEventListener('input', (e) => {
                e.target.value = maskFunction(e.target.value);
            });
        };

        const maskCPF = (value) => {
            return value
                .replace(/\D/g, '') // Remove tudo que não é dígito
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})/, '$1-$2')
                .substring(0, 14);
        };

        const maskCEP = (value) => {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .substring(0, 9);
        };

        const maskPhone = (value) => {
            return value
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d{4})/, '$1-$2')
                .substring(0, 15);
        };

        applyMask(document.getElementById('cpf'), maskCPF);
        applyMask(document.getElementById('responsavel_cpf'), maskCPF);
        applyMask(document.getElementById('cep'), maskCEP);
        applyMask(document.getElementById('telefone'), maskPhone);
        applyMask(document.getElementById('whatsapp'), maskPhone);
        applyMask(document.getElementById('contato1_telefone'), maskPhone);
        applyMask(document.getElementById('responsavel_telefone'), maskPhone);

        // Event delegation para telefones em blocos dinâmicos
        registrosContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('masked-phone')) {
                e.target.value = maskPhone(e.target.value);
            }
        });


        // --- LÓGICA DE SUBMISSÃO E VALIDAÇÃO ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            let fieldsToCheck = allRequiredFields;
            // Se o termo de menor estiver visível, validar seus campos obrigatórios também
            if (!document.getElementById('termoMenorIdade').classList.contains('hidden-field')) {
                const termoRequiredFields = document.querySelectorAll('#termoMenorIdade [required]');
                fieldsToCheck = [...allRequiredFields, ...termoRequiredFields];
            }

            let firstInvalidField = null;
            for (const field of fieldsToCheck) {
                if (!field.checkValidity()) {
                    if (!firstInvalidField) firstInvalidField = field;
                    field.style.borderColor = 'var(--color-alerta)';
                } else {
                    field.style.borderColor = '';
                }
            }

            if (firstInvalidField) {
                firstInvalidField.focus();
                alert('Por favor, preencha todos os campos obrigatórios marcados com *.');
                return;
            }

            successModal.openModal();
        });

        successModalClose.addEventListener('click', () => {
            form.reset();
            arteMarcialSelect.dispatchEvent(new Event('change'));
            document.getElementById('imcResult').classList.add('hidden-field');
            document.getElementById('termoMenorIdade').classList.add('hidden-field');
            registrosContainer.innerHTML = '';
            entidadeCounter = 0;
        });


        // --- LÓGICA DINÂMICA DO FORMULÁRIO (DADOS ESPORTIVOS) ---
        function toggleDetalhes(show) {
            const requiredFields = detalhesGraduacaoDiv.querySelectorAll('[required]');
            if (show) {
                detalhesGraduacaoDiv.classList.remove('hidden-field');
                registrosEntidadesDiv.classList.remove('hidden-field');
                requiredFields.forEach(f => f.setAttribute('required', 'required'));
            } else {
                detalhesGraduacaoDiv.classList.add('hidden-field');
                registrosEntidadesDiv.classList.add('hidden-field');
                requiredFields.forEach(f => f.removeAttribute('required'));
            }
        }

        arteMarcialSelect.addEventListener('change', function() {
            const selectedArt = this.value;
            corFaixaSelect.innerHTML = '<option value="">Selecione a cor</option>';
            corFaixaSelect.disabled = true;

            if (selectedArt && graduacoes[selectedArt]) {
                corFaixaSelect.disabled = false;
                graduacoes[selectedArt].forEach(faixa => {
                    const option = document.createElement('option');
                    option.value = faixa;
                    option.textContent = faixa;
                    corFaixaSelect.appendChild(option);
                });
            }

            // Reseta os campos dependentes
            corFaixaSelect.dispatchEvent(new Event('change'));
        });

        corFaixaSelect.addEventListener('change', function() {
            const selectedFaixa = this.value;
            const isJiuJitsu = arteMarcialSelect.value === 'jiu-jitsu';

            if (selectedFaixa.includes('Branca')) {
                nivelFaixaBrancaContainer.classList.remove('hidden-field');
                toggleDetalhes(nivelFaixaBrancaSelect.value === 'iniciante-ja-treinei');
            } else {
                nivelFaixaBrancaContainer.classList.add('hidden-field');
                toggleDetalhes(!!selectedFaixa);
            }

            grauContainer.classList.add('hidden-field');
            grauSelect.innerHTML = '';
            if (isJiuJitsu) {
                let grauOptions = null;
                if (['Branca', 'Cinza', 'Amarela', 'Laranja', 'Verde', 'Azul', 'Roxa', 'Marrom'].some(cor => selectedFaixa.includes(cor))) {
                    grauOptions = grausJiuJitsuBasico;
                } else if (selectedFaixa.includes('Preta')) {
                    grauOptions = grausJiuJitsuPreta;
                }

                if (grauOptions) {
                    grauOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        grauSelect.appendChild(option);
                    });
                    grauContainer.classList.remove('hidden-field');
                }
            }
        });

        nivelFaixaBrancaSelect.addEventListener('change', function() {
            toggleDetalhes(this.value === 'iniciante-ja-treinei');
        });

        medicamentoRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                medicamentoDescricaoContainer.classList.toggle('hidden-field', this.value !== 'sim');
            });
        });

        // --- LÓGICA DE ADICIONAR/REMOVER REGISTRO DE ENTIDADE (MELHORADA) ---
        addEntidadeBtn.addEventListener('click', function() {
            const template = document.getElementById('entidadeTemplate');
            const clone = template.content.cloneNode(true);
            const currentId = entidadeCounter;

            // Garante que IDs e 'for' sejam únicos
            clone.querySelectorAll('[id]').forEach(element => {
                element.id = `${element.id}_${currentId}`;
            });
            clone.querySelectorAll('label[for]').forEach(label => {
                label.htmlFor = `${label.htmlFor}_${currentId}`;
            });
            // Garante que o grupo de radio buttons seja único para cada bloco
            clone.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.name = `entidadeAtivo_${currentId}`;
            });

            registrosContainer.appendChild(clone);
            entidadeCounter++;
        });

        registrosContainer.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-button')) {
                e.target.closest('.entidade-registro-block').remove();
            }
        });

        // --- LÓGICA DO TERMO DE MENOR ---
        document.getElementById("dataNascimento").addEventListener('change', function() {
            const idadeInput = document.getElementById("idade");
            const termoMenorFieldset = document.getElementById('termoMenorIdade');
            const nomeCompletoInput = document.getElementById('nomeCompleto');
            const nomeMenorInput = document.querySelector('[name="menor_nome_completo"]');
            const dataNascMenorInput = document.querySelector('[name="menor_data_nascimento"]');

            if (this.value) {
                const birthDate = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

                if (age >= 0) {
                    idadeInput.value = age;
                    if (age < 18) {
                        termoMenorFieldset.classList.remove('hidden-field');
                        if(nomeMenorInput) nomeMenorInput.value = nomeCompletoInput.value;
                        if(dataNascMenorInput) dataNascMenorInput.value = this.value;

                    } else {
                        termoMenorFieldset.classList.add('hidden-field');
                    }
                } else {
                    idadeInput.value = "";
                    termoMenorFieldset.classList.add('hidden-field');
                }

            } else {
                idadeInput.value = "";
                termoMenorFieldset.classList.add('hidden-field');
            }
        });

        document.getElementById('nomeCompleto').addEventListener('input', function() {
            const nomeMenorInput = document.querySelector('[name="menor_nome_completo"]');
            const idade = parseInt(document.getElementById("idade").value, 10);
            if (idade < 18 && nomeMenorInput) {
                nomeMenorInput.value = this.value;
            }
        });

        // --- LÓGICA DO GRAU DE PARENTESCO 'OUTROS' ---
        const parentescoRadios = document.querySelectorAll('input[name="grau_parentesco"]');
        const outroParentescoContainer = document.getElementById('outroParentescoContainer');
        const outroParentescoInput = document.getElementById('outro_parentesco_texto');

        parentescoRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Outros') {
                    outroParentescoContainer.classList.remove('hidden-field');
                    outroParentescoInput.setAttribute('required', 'required');
                } else {
                    outroParentescoContainer.classList.add('hidden-field');
                    outroParentescoInput.removeAttribute('required');
                    outroParentescoInput.value = ''; // Limpa o campo ao esconder
                }
            });
        });


        // --- CÁLCULO DE IMC ---
        const alturaInput = document.getElementById("altura");
        const pesoInput = document.getElementById("peso");
        const imcInput = document.getElementById("imc");
        const imcResultDiv = document.getElementById('imcResult');
        const imcClassificationSpan = document.getElementById('imcClassification');
        const imcRiskSpan = document.getElementById('imcRisk');

        function calcularIMC() {
            const alturaStr = alturaInput.value.replace(',', '.');
            const pesoStr = pesoInput.value.replace(',', '.');
            let altura = parseFloat(alturaStr);
            const peso = parseFloat(pesoStr);

            if (altura > 3) altura = altura / 100;

            if (altura > 0 && peso > 0) {
                const imc = peso / (altura * altura);
                imcInput.value = imc.toFixed(2);

                let classification = '', risk = '', resultClass = '';
                if (imc < 18.5) { classification = 'Magreza'; risk = 'Baixo'; resultClass = 'imc-atencao'; }
                else if (imc <= 24.9) { classification = 'Peso adequado'; risk = 'Médio'; resultClass = 'imc-normal'; }
                else if (imc <= 29.9) { classification = 'Sobrepeso'; risk = 'Pouco Elevado'; resultClass = 'imc-atencao'; }
                else if (imc <= 34.9) { classification = 'Obesidade Grau I'; risk = 'Elevado'; resultClass = 'imc-alerta'; }
                else if (imc <= 39.9) { classification = 'Obesidade Grau II'; risk = 'Muito Elevado'; resultClass = 'imc-alerta'; }
                else { classification = 'Obesidade Grau III'; risk = 'Muitíssimo Elevado'; resultClass = 'imc-alerta'; }

                imcClassificationSpan.textContent = classification;
                imcRiskSpan.textContent = risk;

                const resultBox = imcResultDiv.querySelector('.imc-result-box');
                resultBox.className = 'imc-result-box ' + resultClass;
                imcResultDiv.classList.remove('hidden-field');
            } else {
                imcInput.value = "";
                imcResultDiv.classList.add('hidden-field');
            }
        }

        alturaInput.addEventListener('input', calcularIMC);
        pesoInput.addEventListener('input', calcularIMC);
    });
</script>
<script>
    (function(){
        // ---- Validador de CPF (local, sem API externa) ----
        function validarCPF(cpf){
            if(!cpf) return false;
            const num = String(cpf).replace(/\D/g,'');
            if(num.length!==11) return false;
            if(/^(\d)\1{10}$/.test(num)) return false; // todos iguais
            const calc = (b)=>{let s=0;for(let i=0;i<b;i++) s+=parseInt(num[i],10)*(b+1-i);const r=(s*10)%11;return r===10?0:r;};
            const d1 = calc(9), d2 = calc(10);
            return d1===parseInt(num[9],10) && d2===parseInt(num[10],10);
        }

        // pega o FORM e o campo CPF
        const form = document.querySelector('form#formCadastro') || document.querySelector('form');
        const cpfEl = document.getElementById('cpf');
        const msgEl = document.getElementById('cpfErro'); // pode ser null se você não criou o <small>

        if(!form || !cpfEl) return;

        // máscara enquanto digita (000.000.000-00)
        cpfEl.addEventListener('input', () => {
            const pos = cpfEl.selectionStart || 0;
            cpfEl.value = String(cpfEl.value)
                .replace(/\D/g,'')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2')
                .slice(0,14);
            cpfEl.setSelectionRange(pos, pos);
        });

        // valida na hora de enviar
        form.addEventListener('submit', function(e){
            const ok = validarCPF(cpfEl.value);
            if(!ok){
                e.preventDefault();
                cpfEl.style.borderColor = '#ff4d4f';
                if (msgEl) msgEl.textContent = 'CPF inválido. Verifique e tente novamente.';
                else alert('CPF inválido. Verifique e tente novamente.');
                cpfEl.focus();
            } else {
                cpfEl.style.borderColor = '';
                if (msgEl) msgEl.textContent = '';
            }
        });
    })();
</script>
<script>
    (function(){
        const cpfEl = document.getElementById('cpf');
        const msgEl = document.getElementById('cpfErro');
        if (!cpfEl || !msgEl) return;

        function validarCPF(cpf){
            if(!cpf) return false;
            const num = String(cpf).replace(/\D/g,'');
            if (num.length !== 11) return false;
            if (/^(\d)\1{10}$/.test(num)) return false;
            const calc = (b)=>{ let s=0; for (let i=0;i<b;i++) s += parseInt(num[i],10)*(b+1-i);
                const r = (s*10)%11; return r===10?0:r; };
            const d1 = calc(9), d2 = calc(10);
            return d1===parseInt(num[9],10) && d2===parseInt(num[10],10);
        }

        function aplicarMascara(){
            const pos = cpfEl.selectionStart || 0;
            cpfEl.value = String(cpfEl.value)
                .replace(/\D/g,'')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2')
                .slice(0,14);
            cpfEl.setSelectionRange(pos, pos);
        }

        function atualizarMensagem(){
            const puro = cpfEl.value.replace(/\D/g,'');
            if (puro.length < 11) {
                msgEl.textContent = '';
                msgEl.style.display = 'none';
                cpfEl.style.borderColor = '';
                return;
            }
            const ok = validarCPF(cpfEl.value);
            if (ok) {
                msgEl.classList.remove('erro-campo');
                msgEl.classList.add('ok-campo');
                msgEl.textContent = 'CPF válido.';
                msgEl.style.display = 'block';
                msgEl.style.color = 'var(--color-normal)';   // <— usa variável
                cpfEl.style.borderColor = '';
            } else {
                msgEl.classList.remove('ok-campo');
                msgEl.classList.add('erro-campo');
                msgEl.textContent = 'CPF inválido. Verifique e tente novamente.';
                msgEl.style.display = 'block';
                msgEl.style.color = 'var(--color-alerta)';  // <— usa variável
                cpfEl.style.borderColor = 'var(--color-alerta)';
            }
        }

        cpfEl.addEventListener('input', function(){
            aplicarMascara();
            atualizarMensagem();
        });

        // roda uma vez ao carregar (se já tiver valor)
        aplicarMascara();
        atualizarMensagem();
    })();
</script>
<script src="../../shared/js/auth.js"></script>
<script>
    (() => {
        const btn   = document.getElementById('cameraButton');
        const video = document.getElementById('cameraPreview');

        if (!btn || !video) {
            alert('IDs não encontrados: cameraButton / cameraPreview');
            return;
        }

        let stream = null;

        btn.addEventListener('click', async () => {
            try {
                // encerra stream anterior, se houver
                if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

                console.log('Solicitando getUserMedia...');
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });

                console.log('getUserMedia OK:', stream);
                video.srcObject = stream;
                video.style.display = 'block';
                video.setAttribute('playsinline', '');  // iOS-friendly
                btn.textContent = 'Câmera ligada';
                alert('CÂMERA OK (permissões e hardware funcionando)');
            } catch (err) {
                console.error('Erro getUserMedia:', err.name, err.message);
                alert('Falhou: ' + err.name + ' - ' + err.message);
            }
        });
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form             = document.getElementById('formCadastro') || document.querySelector('form');
        const video            = document.getElementById('cameraPreview');
        const img              = document.getElementById('previewImage');
        const btnOpen          = document.getElementById('cameraButton');
        const btnShot          = document.getElementById('captureButton');
        const btnConfirm       = document.getElementById('photoSubmitButton');

        let stream = null;
        let lastDataUrl = null;

        // Quando clicar em "Abrir Câmera", garanta que o botão "Tirar Foto" apareça
        btnOpen?.addEventListener('click', () => {
            if (btnShot)      btnShot.style.display = 'inline-block';
            if (btnConfirm)   btnConfirm.style.display = 'none';
            if (img)          img.style.display = 'none';
            if (video)        video.style.display = 'block';
        });

        // Tirar foto do vídeo
        btnShot?.addEventListener('click', () => {
            if (!video || !video.srcObject) {
                alert('Abra a câmera primeiro.');
                return;
            }

            const w = video.videoWidth || 800;
            const h = video.videoHeight || 600;
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);

            // Gera imagem (base64)
            lastDataUrl = canvas.toDataURL('image/jpeg', 0.92);

            // Mostra a prévia
            if (img) {
                img.src = lastDataUrl;
                img.style.display = 'block';
            }

            // Alterna a UI
            if (video) {
                // libera a câmera
                try { video.srcObject?.getTracks().forEach(t => t.stop()); } catch(e) {}
                video.srcObject = null;
                video.style.display = 'none';
            }
            if (btnShot)    btnShot.style.display = 'none';
            if (btnConfirm) btnConfirm.style.display = 'inline-block';
        });

        // Confirmar foto: salva em um input hidden para ir junto do formulário
        btnConfirm?.addEventListener('click', () => {
            if (!lastDataUrl && img?.src) lastDataUrl = img.src;
            if (!lastDataUrl) {
                alert('Tire ou selecione uma foto antes de confirmar.');
                return;
            }
            let hidden = document.getElementById('photoData');
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.id = 'photoData';
                hidden.name = 'photoData';
                form?.appendChild(hidden);
            }
            hidden.value = lastDataUrl; // base64 da imagem

            // Feedback visual rápido
            const old = btnConfirm.textContent;
            btnConfirm.textContent = 'Foto confirmada ✓';
            setTimeout(() => { btnConfirm.textContent = old; }, 1500);
        });
    });
</script>
<script id="BACK_LINK_ADMIN_FIX">
    (function(){
        var url=new URL(location.href);
        var fromAdmin = (url.searchParams.get("from")==="admin");
        function getSess(){ try{return JSON.parse(localStorage.getItem("kokoro_session")||"null");}catch(e){return null;} }
        var sess=getSess();
        var isAdmin = !!(sess && (sess.role==="admin" || sess.role==="Administrador"));
        /* acha o link com texto "Voltar ao Início" */
        var back = Array.from(document.querySelectorAll("a")).find(function(a){
            return /voltar ao início/i.test((a.textContent||"").trim());
        });
        if(back && (fromAdmin || isAdmin)){
            back.href = "/admin/index.html";
            back.textContent = "Voltar ao Admin";
        }
    })();
</script>
</body>
</html>

