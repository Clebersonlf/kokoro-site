<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro - Cadastro de Atleta (Versão Melhorada)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- GERAL E VARIÁVEIS (TEMA ESCURO) --- */
        :root {
            --primary-color: #976803; /* Verde-água para destaque */
            --secondary-color: #A0AEC0; /* Cinza claro para texto secundário */
            --background-color: #1A202C; /* Fundo principal (cinza-chumbo bem escuro) */
            --card-background: #2D3748; /* Fundo do formulário (cinza-chumbo mais claro) */
            --text-color: #E2E8F0; /* Texto principal (branco suave) */
            --label-color: #CBD5E0; /* Cor das etiquetas */
            --border-color: #4A5568; /* Cor das bordas */
            --input-background: #1A202C; /* Fundo dos campos de texto */

            /* Cores para cada seção */
            --section-color-1: #2B6CB0; /* Azul */
            --section-color-2: #2F855A; /* Verde */
            --section-color-3: #B7791F; /* Ocre */
            --section-color-4: #6B46C1; /* Roxo */
            --section-color-5: #C53030; /* Vermelho */

            /* Cores de classificação IMC */
            --color-normal: #38A169; /* Verde */
            --color-atencao: #D69E2E; /* Amarelo */
            --color-alerta: #E53E3E; /* Vermelho */
        }

        /* --- ESTILOS DA PÁGINA DE CADASTRO --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: padding-top 0.3s ease;
        }

        .form-wrapper {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .form-main-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
        }

        .form-main-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .header-controls a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .header-controls a:hover {
            color: #fff;
        }

        form {
            padding: 2rem;
        }

        .form-section {
            border: none;
            padding: 0;
            margin: 0 0 2.5rem 0;
        }

        .form-section legend {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* MELHORIA: Seletores de legenda baseados em classe, mais robustos que :nth-of-type. */
        .section-personal > legend { background-color: var(--section-color-1); }
        .section-sports > legend { background-color: var(--section-color-2); }
        .section-biometric > legend { background-color: var(--section-color-3); }
        .section-emergency > legend { background-color: var(--section-color-4); }
        .section-parq > legend { background-color: var(--section-color-5); }


        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .sub-section {
            grid-column: span 2;
            background-color: rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .sub-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--label-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.span-2 {
            grid-column: span 2;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--label-color);
            margin-bottom: 0.5rem;
            cursor: pointer; /* MELHORIA: Melhor usabilidade */
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--color-alerta);
        }

        body.admin-mode-active .form-group label.required::after {
            content: '';
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 400; /* Normal weight for radio options */
        }
        
        .radio-group input[type="radio"] {
             margin-right: 0.25rem;
        }


        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background-color: var(--input-background);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(129, 230, 217, 0.3);
        }

        .form-group input[readonly] {
            background-color: #2D3748;
            cursor: not-allowed;
        }

        .hidden-field {
            display: none !important;
        }

        .parq-question {
            background-color: #1A202C;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        .parq-question p { margin: 0 0 0.5rem 0; font-size: 0.9rem; font-weight: 500;}
        .parq-question div label { margin-right: 1rem; font-size: 0.9rem; font-weight: 400; color: var(--secondary-color);}
        .parq-question div input { margin-right: 0.25rem; }

        .final-section {
            border-top: 1px solid var(--border-color);
            padding-top: 2rem;
            margin-top: 1rem;
        }

        .terms-box {
            background-color: #1A202C;
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--secondary-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            height: 1.15rem;
            width: 1.15rem;
            margin-right: 0.75rem;
            accent-color: var(--primary-color);
            flex-shrink: 0;
            cursor: pointer;
        }
        .checkbox-group label {
            font-size: 1rem;
            color: var(--secondary-color);
            margin: 0;
            font-weight: 400;
        }

        .submit-button, .modal-button, .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .submit-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            color: #1A202C;
            background-color: var(--primary-color);
        }
        .submit-button:hover {
            background-color: #4FD1C5;
        }

        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--card-background);
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .imc-result-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            color: white;
            transition: all 0.3s ease;
        }

        .imc-result-box p {
            margin: 0;
            font-size: 0.95rem;
        }

        .imc-result-box p:first-child {
            margin-bottom: 0.5rem;
        }

        .imc-result-box strong {
            font-weight: 600;
        }

        .imc-normal { background-color: var(--color-normal); }
        .imc-atencao { background-color: var(--color-atencao); }
        .imc-alerta { background-color: var(--color-alerta); }

        .entidade-registro-block {
            border: 1px solid var(--border-color);
            background-color: #1A202C;
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            position: relative;
        }

        .add-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: #1A202C;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            margin-top: 1rem;
        }
        .add-button:hover {
            background-color: #4FD1C5;
        }

        .remove-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--color-alerta);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 24px;
            text-align: center;
        }

        .admin-mode-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .admin-toggle-label {
            color: var(--secondary-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4A5568;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .admin-banner {
            width: 100%;
            background-color: var(--color-atencao);
            color: #fff;
            text-align: center;
            padding: 0.75rem;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        
        .admin-banner strong {
            color: #1A202C;
        }

        body.admin-mode-active {
            padding-top: 5rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--card-background);
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--text-color);
        }

        .modal-content p {
            color: var(--secondary-color);
            line-height: 1.6;
        }

        .modal-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .modal-button-secondary {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            margin-top: 1rem;
        }
        
        .modal-button-secondary:hover {
            background-color: var(--border-color);
        }

        #adminPasswordError {
            color: var(--color-alerta);
            font-size: 0.9rem;
            margin-top: 1rem;
            height: 1.2em;
        }

        /* ESTILOS DA FOTO DE PERFIL */
        .photo-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .preview-area {
            width: 100%;
            height: 250px;
            border: 2px dashed var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--input-background);
            border-radius: 8px;
        }

        .preview-area video, .preview-area img {
            max-width: 100%;
            max-height: 100%;
        }

        .button-area {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap; /* MELHORIA: Para melhor visualização em telas pequenas */
        }

        .btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .btn:hover {
            background-color: var(--border-color);
        }

        .btn.success {
            background-color: var(--color-normal);
            color: white;
        }


        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            .form-group.span-2 {
                grid-column: span 1;
            }
            body {
                padding: 1rem;
            }
            body.admin-mode-active {
                padding-top: 6rem;
            }
            .form-wrapper {
                padding: 0;
            }
            .form-main-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            form {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="form-body">

<div id="adminBanner" class="admin-banner hidden-field" role="alert">
    <strong>Modo Desenvolvedor Ativado:</strong> Campos obrigatórios foram desabilitados.
</div>

<main class="form-wrapper">
    <header class="form-main-header">
        <h1>Cadastro</h1>
        <div class="header-controls">
            <a href="/">Voltar ao Início</a>
            <div class="admin-mode-container">
                <label for="adminToggle" class="admin-toggle-label">Admin</label>
                <label class="switch">
                    <input type="checkbox" id="adminToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </header>

    <form id="registerForm" action="/cadastro" method="post" novalidate> <fieldset class="form-section section-personal">
            <legend>Dados Pessoais</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="nomeCompleto">Nome</label>
                    <input type="text" id="nomeCompleto" name="nomeCompleto" required>
                </div>
                <div class="form-group">
                    <label class="required">Sexo</label>
                    <div class="radio-group" style="display: flex; gap: 20px; margin-top: 8px;">
                        <label for="sexoMasc">
                            <input type="radio" id="sexoMasc" name="sexo" value="masculino" required>
                            <span>Masculino</span>
                        </label>
                        <label for="sexoFem">
                            <input type="radio" id="sexoFem" name="sexo" value="feminino" required>
                            <span>Feminino</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="required" for="nomeMae">Mãe</label>
                    <input type="text" id="nomeMae" name="nomeMae" required>
                </div>
                <div class="form-group">
                    <label class="required" for="nomePai">Pai</label>
                    <input type="text" id="nomePai" name="nomePai" required>
                </div>
                <div class="form-group">
                    <label class="required" for="rg">RG</label>
                    <input type="text" id="rg" name="rg" required>
                </div>
                <div class="form-group">
                    <label class="required" for="cpf">CPF</label>
                    <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00" maxlength="14">
                    <small id="cpfErro" class="erro-campo" style="margin-top: 20px; display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="required" for="dataNascimento">Data de Nascimento</label>
                    <input type="date" id="dataNascimento" name="dataNascimento" required>
                </div>
                <div class="form-group">
                    <label for="idade">Idade</label>
                    <input type="text" id="idade" name="idade" readonly>
                </div>
                <div class="form-group span-2">
                    <label class="required" for="endereco">Endereço</label>
                    <input type="text" id="endereco" name="endereco" required>
                </div>
                <div class="form-group span-2">
                    <label for="complemento">Complemento</label>
                    <input type="text" id="complemento" name="complemento">
                </div>
                <div class="form-group">
                    <label class="required" for="bairro">Bairro</label>
                    <input type="text" id="bairro" name="bairro" required>
                </div>
                <div class="form-group">
                    <label class="required" for="cep">CEP</label>
                    <input type="text" id="cep" name="cep" required placeholder="00000-000" maxlength="9">
                </div>
                <div class="form-group span-2">
                    <label for="referencia">Referência</label>
                    <input type="text" id="referencia" name="referencia">
                </div>
                <div class="form-group">
                    <label class="required" for="telefone">Telefone</label>
                    <input type="tel" id="telefone" name="telefone" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
                <div class="form-group">
                    <label class="required" for="whatsapp">WhatsApp / Telegram</label>
                    <input type="tel" id="whatsapp" name="whatsapp" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
                <div class="form-group span-2">
                    <label class="required" for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group span-2">
                    <label>Foto de Perfil</label>
                    <div class="photo-container">
                        <div class="preview-area">
                            <img id="previewImage" src="" alt="Pré-visualização da foto" style="display: none;">
                            <video id="cameraPreview" style="display: none;" autoplay playsinline></video>
                            <input type="hidden" id="selfiePath">
                        </div>
                        <div class="button-area">
                            <label for="fileInput" class="btn">Escolher Arquivo</label>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            <button type="button" id="cameraButton" class="btn">Abrir Câmera</button>
                            <button type="button" id="captureButton" class="btn" style="display: none;">Tirar Foto</button>
                            <button type="button" id="photoSubmitButton" class="btn" style="display: none;">
                                Confirmar Foto
                            </button>
                            <button type="button" id="retakeButton" class="btn" style="display: none;">Refazer Foto</button>
                            <button type="button" id="cropButton" class="btn" style="display: none;">Recortar Foto</button>

                            <!-- Canvas que usaremos para recorte (fica escondido por enquanto) -->
                            <canvas id="cropCanvas" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-sports">
            <legend>Dados Esportivos</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="arteMarcial">Qual esporte</label>
                    <select id="arteMarcial" name="arteMarcial" required>
                        <option value="">Selecione</option>
                        <option value="jiu-jitsu">Jiu-Jitsu</option>
                        <option value="judo">Judô</option>
                        <option value="karate">Karatê</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required" for="corFaixa">Cor da Faixa</label>
                    <select id="corFaixa" name="corFaixa" required disabled>
                        <option value="">Selecione o esporte primeiro</option>
                    </select>
                </div>

                <div id="nivelFaixaBrancaContainer" class="form-group span-2 hidden-field">
                    <label class="required" for="nivelFaixaBranca">Qual seu nível de experiência?</label>
                    <select id="nivelFaixaBranca" name="nivelFaixaBranca">
                        <option value="iniciante-absoluto">Iniciante absoluto (nunca treinei)</option>
                        <option value="iniciante-ja-treinei">Iniciante (já treinei antes)</option>
                    </select>
                </div>

                <div id="detalhesGraduacao" class="sub-section hidden-field">
                    <h3 class="sub-section-title">Detalhes da Graduação</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label class="required" for="anoGraduacao">Ano da última graduação</label>
                            <input type="number" id="anoGraduacao" name="anoGraduacao" placeholder="Ex: 2023">
                        </div>
                        <div id="grauContainer" class="form-group">
                            <label for="grau">Grau(s) na faixa</label>
                            <select id="grau" name="grau"></select>
                        </div>
                        <div class="form-group span-2">
                            <label for="nomeEquipe">Nome da equipe que pertencia</label>
                            <input type="text" id="nomeEquipe" name="nomeEquipe">
                        </div>
                        <div class="form-group">
                            <label for="nomeProfessor">Nome do professor</label>
                            <input type="text" id="nomeProfessor" name="nomeProfessor">
                        </div>
                        <div class="form-group">
                            <label class="required" for="graduacaoProfessor">Graduação do Professor</label>
                            <input type="text" id="graduacaoProfessor" name="graduacaoProfessor" placeholder="Ex: Faixa Preta 4º Grau" required>
                        </div>
                    </div>
                </div>

                <div id="registrosEntidades" class="sub-section hidden-field">
                    <h3 class="sub-section-title">Registros em Entidades Anteriores</h3>
                    <div id="registrosContainer"></div>
                    <button type="button" id="addEntidadeBtn" class="add-button">+ Adicionar Registro</button>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-biometric">
            <legend>Dados Biométricos</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="peso">Peso (kg)</label>
                    <input type="text" id="peso" name="peso" required placeholder="Ex: 75,5">
                </div>
                <div class="form-group">
                    <label class="required" for="altura">Altura (m)</label>
                    <input type="text" id="altura" name="altura" required placeholder="Ex: 1,80">
                </div>
                <div class="form-group span-2">
                    <div class="label-with-tooltip">
                        <label for="imc">IMC</label>
                        <button type="button" id="imcInfoIcon" class="tooltip-icon" aria-label="Mais informações sobre IMC">?</button>
                    </div>
                    <input type="text" id="imc" name="imc" readonly placeholder="Automático">
                </div>
                <div id="imcResult" class="form-group span-2 hidden-field">
                    <div class="imc-result-box" role="alert">
                        <p><strong>Classificação:</strong> <span id="imcClassification"></span></p>
                        <p><strong>Risco de Comorbidades:</strong> <span id="imcRisk"></span></p>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-emergency">
            <legend>Contato de Emergência</legend>
            <div class="grid-container">
                <div class="form-group">
                    <label class="required" for="contato1_nome">Nome</label>
                    <input type="text" id="contato1_nome" name="contato1_nome" required>
                </div>
                <div class="form-group">
                    <label class="required" for="contato1_parentesco">Grau de parentesco</label>
                    <input type="text" id="contato1_parentesco" name="contato1_parentesco" required>
                </div>
                <div class="form-group span-2">
                    <label for="contato1_endereco">Endereço</label>
                    <input type="text" id="contato1_endereco" name="contato1_endereco">
                </div>
                <div class="form-group span-2">
                    <label class="required" for="contato1_telefone">Telefone</label>
                    <input type="tel" id="contato1_telefone" name="contato1_telefone" required placeholder="(00) 00000-0000" maxlength="15">
                </div>
            </div>
        </fieldset>

        <fieldset class="form-section section-parq">
            <legend>Questionário de Prontidão para Atividade Física (PAR-Q)</legend>
            <div class="parq-question">
                <p>1. Algum médico já lhe disse que você possui algum problema de coração e que só deveria realizar atividade física supervisionado por profissionais de saúde?</p>
                <div>
                    <input type="radio" id="parq1_sim" name="parq1" value="sim" required><label for="parq1_sim">Sim</label>
                    <input type="radio" id="parq1_nao" name="parq1" value="nao"><label for="parq1_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>2. Você sente dores no peito quando pratica atividade física?</p>
                <div>
                    <input type="radio" id="parq2_sim" name="parq2" value="sim" required><label for="parq2_sim">Sim</label>
                    <input type="radio" id="parq2_nao" name="parq2" value="nao"><label for="parq2_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>3. No último mês, você sentiu dores no peito mesmo sem ter praticado atividade física?</p>
                <div>
                    <input type="radio" id="parq3_sim" name="parq3" value="sim" required><label for="parq3_sim">Sim</label>
                    <input type="radio" id="parq3_nao" name="parq3" value="nao"><label for="parq3_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>4. Você apresenta desequilíbrio devido a tontura e/ou já teve alguma perda de consciência?</p>
                <div>
                    <input type="radio" id="parq4_sim" name="parq4" value="sim" required><label for="parq4_sim">Sim</label>
                    <input type="radio" id="parq4_nao" name="parq4" value="nao"><label for="parq4_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>5. Você possui algum problema ósseo ou articular que poderia ser agravado pela atividade física?</p>
                <div>
                    <input type="radio" id="parq5_sim" name="parq5" value="sim" required><label for="parq5_sim">Sim</label>
                    <input type="radio" id="parq5_nao" name="parq5" value="nao"><label for="parq5_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>6. Você toma atualmente algum medicamento para pressão arterial ou coração?</p>
                <div>
                    <input type="radio" id="parq6_sim" name="parq6" value="sim" required><label for="parq6_sim">Sim</label>
                    <input type="radio" id="parq6_nao" name="parq6" value="nao"><label for="parq6_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>7. Você sabe de alguma outra razão pela qual não deveria praticar atividade física?</p>
                <div>
                    <input type="radio" id="parq7_sim" name="parq7" value="sim" required><label for="parq7_sim">Sim</label>
                    <input type="radio" id="parq7_nao" name="parq7" value="nao"><label for="parq7_nao">Não</label>
                </div>
            </div>
            <div class="parq-question">
                <p>8. Você faz uso de algum medicamento de uso contínuo ou controlado?</p>
                <div>
                    <input type="radio" id="medicamento_sim" name="medicamento" value="sim" required><label for="medicamento_sim">Sim</label>
                    <input type="radio" id="medicamento_nao" name="medicamento" value="nao"><label for="medicamento_nao">Não</label>
                </div>
            </div>
            <div id="medicamentoDescricaoContainer" class="form-group span-2 hidden-field">
                <label class="required" for="medicamentoDescricao">Por favor, descreva quais medicamentos você utiliza:</label>
                <textarea id="medicamentoDescricao" name="medicamentoDescricao"></textarea>
            </div>
        </fieldset>

        <div class="final-section">
            <div class="terms-box" tabindex="0">
                <strong>Termos e Condições de Uso e Responsabilidade</strong><br>
                <ol>
                    <li><strong>Veracidade das Informações:</strong> Você declara que todas as informações fornecidas neste formulário são verdadeiras, completas e precisas.</li>
                    <li><strong>Recomendação Médica:</strong> Você reconhece que, se respondeu "Sim" a qualquer uma das perguntas do PAR-Q, é altamente recomendável consultar um médico antes de iniciar ou aumentar a intensidade de qualquer atividade física.</li>
                    <li><strong>Assunção de Risco:</strong> Você compreende e aceita que a prática de artes marciais e atividades físicas relacionadas envolve riscos inerentes de lesões. Você assume voluntariamente todos os riscos associados à sua participação.</li>
                    <li><strong>Isenção de Responsabilidade:</strong> Você isenta o portal Kokoro, seus instrutores, administradores e parceiros de qualquer responsabilidade por lesões, danos ou perdas que possam ocorrer como resultado de sua participação.</li>
                    <li><strong>Uso de Dados (LGPD):</strong> Você autoriza o portal Kokoro a coletar e utilizar seus dados para fins de gestão de cadastro, comunicação e emergência, em conformidade com a Lei Geral de Proteção de Dados (LGPD).</li>
                </ol>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="dadosVerdadeiros" name="dadosVerdadeiros" required>
                <label for="dadosVerdadeiros">Declaro que os dados fornecidos são verdadeiros e estou ciente das responsabilidades legais.</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="aceitoTermos" name="aceitoTermos" required>
                <label for="aceitoTermos">Li e aceito os termos e condições.</label>
            </div>
            <button type="submit" class="submit-button">Cadastrar</button>
        </div>
    </form>
</main>

<template id="entidadeTemplate">
    <div class="entidade-registro-block">
        <button type="button" class="remove-button" aria-label="Remover este registro">&times;</button>
        <div class="grid-container">
            <div class="form-group span-2">
                <label class="required" for="entidadeNome">Nome da Entidade</label>
                <input type="text" name="entidadeNome[]" id="entidadeNome" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeSigla">Sigla</label>
                <input type="text" name="entidadeSigla[]" id="entidadeSigla" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeRegistro">Nº de Registro</label>
                <input type="text" name="entidadeRegistro[]" id="entidadeRegistro" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadeEstado">Estado</label>
                <input type="text" name="entidadeEstado[]" id="entidadeEstado" required>
            </div>
            <div class="form-group">
                <label class="required" for="entidadePais">País</label>
                <input type="text" name="entidadePais[]" id="entidadePais" required>
            </div>
            <div class="form-group span-2">
                <label for="entidadeSite">Link (Site) da Entidade</label>
                <input type="text" name="entidadeSite[]" id="entidadeSite">
            </div>
            <div class="form-group">
                <label for="entidadeTelefone">Telefone</label>
                <input type="tel" name="entidadeTelefone[]" id="entidadeTelefone" class="masked-phone" placeholder="(00) 00000-0000" maxlength="15">
            </div>
            <div class="form-group">
                <label for="entidadeEmail">Email</label>
                <input type="email" name="entidadeEmail[]" id="entidadeEmail">
            </div>
            <div class="form-group span-2">
                <label class="required">Está ativo nesta entidade?</label>
                <div class="radio-group">
                    <input type="radio" name="entidadeAtivo" value="sim" id="entidadeAtivo_sim" required><label for="entidadeAtivo_sim">Sim</label>
                    <input type="radio" name="entidadeAtivo" value="nao" id="entidadeAtivo_nao"><label for="entidadeAtivo_nao">Não</label>
                </div>
            </div>
        </div>
    </div>
</template>

<div id="adminPasswordModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
        <h2 id="adminModalTitle">Acesso Restrito</h2>
        <p><strong>Aviso:</strong> Esta funcionalidade é para desenvolvimento. A senha é visível no código-fonte. <strong>Não use em produção.</strong></p>
        <div class="form-group">
            <label for="adminPassword" style="text-align: left;">Senha</label>
            <input type="password" id="adminPassword">
        </div>
        <div id="adminPasswordError"></div>
        <button id="adminPasswordConfirm" class="modal-button">Confirmar</button>
        <button id="adminPasswordCancel" class="modal-button modal-button-secondary">Cancelar</button>
    </div>
</div>

<div id="successModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="successModalTitle">
        <div class="modal-icon">&#10004;</div>
        <h2 id="successModalTitle">Cadastro Realizado!</h2>
        <p>Seu cadastro foi enviado com sucesso. Bem-vindo à plataforma Kokoro!</p>
        <button id="successModalClose" class="modal-button">Fechar</button>
    </div>
</div>

<div id="imcInfoModal" class="modal-overlay hidden-field">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="imcInfoModalTitle">
        <h2 id="imcInfoModalTitle">O que é o IMC?</h2>
        <p>O Índice de Massa Corporal (IMC) é uma medida simples e amplamente utilizada para avaliar o estado nutricional de uma pessoa, calculado pela fórmula: IMC = peso / (altura²).</p>
        <button id="imcInfoClose" class="modal-button">Entendi</button>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('registerForm');
    const body = document.body;
    if (!form) return;

    // --- BANCO DE DADOS DAS GRADUAÇÕES ---
    const graduacoes = {
        'jiu-jitsu': ['Faixa Branca', 'Faixa Cinza e Branca', 'Faixa Cinza', 'Faixa Cinza e Preta', 'Faixa Amarela e Branca', 'Faixa Amarela', 'Faixa Amarela e Preta', 'Faixa Laranja e Branca', 'Faixa Laranja', 'Faixa Laranja e Preta', 'Faixa Verde e Branca', 'Faixa Verde', 'Faixa Verde e Preta', 'Faixa Azul', 'Faixa Roxa', 'Faixa Marrom', 'Faixa Preta', 'Faixa Vermelha e Preta – 7º Grau', 'Faixa Vermelha e Branca – 8º Grau', 'Faixa Vermelha – 9º Grau', 'Faixa Vermelha – 10º Grau'],
        'judo': ['Faixa Branca – 6º kyū', 'Faixa Cinza ou Azul-Clara – 5º kyū', 'Faixa Laranja – 4º kyū', 'Faixa Verde – 3º kyū', 'Faixa Azul – 2º kyū', 'Faixa Marrom – 1º kyū', 'Faixa Preta – 1º dan', 'Faixa Preta – 2º dan', 'Faixa Preta – 3º dan', 'Faixa Preta – 4º dan', 'Faixa Preta – 5º dan', 'Faixa Vermelha e Preta – 6º dan', 'Faixa Vermelha e Preta – 7º dan', 'Faixa Vermelha – 8º dan', 'Faixa Vermelha – 9º dan', 'Faixa Vermelha – 10º dan'],
        'karate': ['Faixa Branca – 9º kyū', 'Faixa Amarela – 8º kyū', 'Faixa Laranja – 7º kyū', 'Faixa Verde – 6º kyū', 'Faixa Azul – 5º kyū', 'Faixa Azul (escuro) – 4º kyū', 'Faixa Marrom (1º nível) – 3º kyū', 'Faixa Marrom (2º nível) – 2º kyū', 'Faixa Marrom (3º nível) – 1º kyū', 'Faixa Preta – 1º dan', 'Faixa Preta – 2º dan', 'Faixa Preta – 3º dan', 'Faixa Preta – 4º dan', 'Faixa Preta – 5º dan', 'Faixa Coral – 6º dan', 'Faixa Coral – 7º dan', 'Faixa Vermelha e Branca – 8º dan', 'Faixa Vermelha – 9º dan', 'Faixa Vermelha – 10º dan']
    };
    const grausJiuJitsuBasico = ['Lisa', '1º Grau', '2º Grau', '3º Grau', '4º Grau'];
    const grausJiuJitsuPreta = ['Lisa', '1º Grau', '2º Grau', '3º Grau', '4º Grau', '5º Grau', '6º Grau'];
    
    // --- ELEMENTOS DO DOM ---
    const allRequiredFields = Array.from(form.querySelectorAll('[required]'));
    const arteMarcialSelect = document.getElementById("arteMarcial");
    const corFaixaSelect = document.getElementById("corFaixa");
    const nivelFaixaBrancaContainer = document.getElementById('nivelFaixaBrancaContainer');
    const nivelFaixaBrancaSelect = document.getElementById('nivelFaixaBranca');
    const detalhesGraduacaoDiv = document.getElementById('detalhesGraduacao');
    const grauContainer = document.getElementById('grauContainer');
    const grauSelect = document.getElementById('grau');
    const registrosEntidadesDiv = document.getElementById('registrosEntidades');
    const addEntidadeBtn = document.getElementById('addEntidadeBtn');
    const registrosContainer = document.getElementById('registrosContainer');
    const medicamentoRadios = document.querySelectorAll('input[name="medicamento"]');
    const medicamentoDescricaoContainer = document.getElementById('medicamentoDescricaoContainer');
    
    // --- VARIÁVEIS DE ESTADO ---
    let entidadeCounter = 0; // MELHORIA: Contador para IDs únicos nos blocos de entidade
    let stream = null;
    let currentPhoto = null;

    // ===================================================================
    // MELHORIA: LÓGICA DE MODAIS REATORADA E ACESSÍVEL
    // ===================================================================
    function setupModal(modalId, openTriggerId, closeTriggerId) {
        const modal = document.getElementById(modalId);
        const openTrigger = document.getElementById(openTriggerId);
        const closeTrigger = document.getElementById(closeTriggerId);

        if (!modal) return;

        const openModal = () => {
            modal.classList.remove('hidden-field');
            body.style.overflow = 'hidden'; // Impede o scroll do fundo
            modal.querySelector('button, input, select, textarea').focus(); // Foco no primeiro elemento interativo
        };

        const closeModal = () => {
            modal.classList.add('hidden-field');
            body.style.overflow = '';
            if(openTrigger) openTrigger.focus(); // Retorna o foco ao botão que abriu
        };

        if (openTrigger) {
            openTrigger.addEventListener('click', openModal);
        }

        if (closeTrigger) {
            closeTrigger.addEventListener('click', closeModal);
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(); // Fecha se clicar no overlay
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden-field')) {
                closeModal();
            }
        });

        // Retorna as funções para controle externo se necessário
        return { openModal, closeModal };
    }
    
    const successModal = setupModal('successModal', null, 'successModalClose');
    const imcInfoModal = setupModal('imcInfoModal', 'imcInfoIcon', 'imcInfoClose');

    // ===================================================================
    // MELHORIA: LÓGICA DE MODO ADMIN COM AVISOS DE SEGURANÇA
    // ===================================================================
    const adminToggle = document.getElementById('adminToggle');
    const adminBanner = document.getElementById('adminBanner');
    const adminPasswordModalEl = document.getElementById('adminPasswordModal');
    const adminPasswordInput = document.getElementById('adminPassword');
    const adminPasswordConfirmBtn = document.getElementById('adminPasswordConfirm');
    const adminPasswordCancelBtn = document.getElementById('adminPasswordCancel');
    const adminPasswordError = document.getElementById('adminPasswordError');

    const closeAdminModal = () => {
        adminPasswordModalEl.classList.add('hidden-field');
        if (!body.classList.contains('admin-mode-active')) {
            adminToggle.checked = false;
        }
        adminPasswordInput.value = '';
        adminPasswordError.textContent = '';
    }
    
    adminToggle.addEventListener('change', function() {
        if (this.checked) {
            adminPasswordModalEl.classList.remove('hidden-field');
            adminPasswordInput.focus();
        } else {
            // Desativar modo admin
            adminBanner.classList.add('hidden-field');
            body.classList.remove('admin-mode-active');
            allRequiredFields.forEach(field => field.setAttribute('required', 'required'));
        }
    });

    adminPasswordConfirmBtn.addEventListener('click', function() {
        // AVISO DE SEGURANÇA: Esta validação é insegura e apenas para fins de
        // prototipagem. Em um ambiente de produção, a senha deve ser validada
        // no servidor.
        if (adminPasswordInput.value === 'kokoroadmin') {
            adminBanner.classList.remove('hidden-field');
            body.classList.add('admin-mode-active');
            allRequiredFields.forEach(field => field.removeAttribute('required'));
            closeAdminModal();
        } else {
            adminPasswordError.textContent = 'Senha incorreta.';
            adminPasswordInput.focus();
        }
    });

    adminPasswordCancelBtn.addEventListener('click', closeAdminModal);
    adminPasswordModalEl.addEventListener('click', (e) => { if (e.target === adminPasswordModalEl) closeAdminModal(); });


    // ===================================================================
    // MELHORIA: MÁSCARAS DE INPUT PARA CPF, CEP E TELEFONE
    // ===================================================================
    const applyMask = (element, maskFunction) => {
        element.addEventListener('input', (e) => {
            e.target.value = maskFunction(e.target.value);
        });
    };

    const maskCPF = (value) => {
        return value
            .replace(/\D/g, '') // Remove tudo que não é dígito
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d{1,2})/, '$1-$2')
            .substring(0, 14);
    };

    const maskCEP = (value) => {
        return value
            .replace(/\D/g, '')
            .replace(/(\d{5})(\d)/, '$1-$2')
            .substring(0, 9);
    };

    const maskPhone = (value) => {
        return value
            .replace(/\D/g, '')
            .replace(/(\d{2})(\d)/, '($1) $2')
            .replace(/(\d{5})(\d{4})/, '$1-$2')
            .substring(0, 15);
    };

    applyMask(document.getElementById('cpf'), maskCPF);
    applyMask(document.getElementById('cep'), maskCEP);
    applyMask(document.getElementById('telefone'), maskPhone);
    applyMask(document.getElementById('whatsapp'), maskPhone);
    applyMask(document.getElementById('contato1_telefone'), maskPhone);
    
    // Event delegation para telefones em blocos dinâmicos
    registrosContainer.addEventListener('input', (e) => {
        if (e.target.classList.contains('masked-phone')) {
            e.target.value = maskPhone(e.target.value);
        }
    });


    // --- LÓGICA DE SUBMISSÃO E VALIDAÇÃO ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validação customizada
        let firstInvalidField = null;
        for (const field of allRequiredFields) {
            if (!field.checkValidity()) {
                 if (!firstInvalidField) firstInvalidField = field;
                 // Adicionar estilo de erro (opcional)
                 field.style.borderColor = 'var(--color-alerta)';
            } else {
                 field.style.borderColor = ''; // Limpar estilo
            }
        }
        
        if (firstInvalidField) {
            firstInvalidField.focus();
            alert('Por favor, preencha todos os campos obrigatórios marcados com *.');
            return;
        }

        // Se tudo estiver válido, mostra o modal de sucesso
        successModal.openModal();
    });
    
    successModalClose.addEventListener('click', () => {
         form.reset();
         // Dispara eventos para resetar campos dinâmicos
         arteMarcialSelect.dispatchEvent(new Event('change'));
         document.getElementById('imcResult').classList.add('hidden-field');
         // Limpa os blocos de entidade
         registrosContainer.innerHTML = '';
         entidadeCounter = 0;
    });


    // --- LÓGICA DINÂMICA DO FORMULÁRIO (DADOS ESPORTIVOS) ---
    function toggleDetalhes(show) {
        const requiredFields = detalhesGraduacaoDiv.querySelectorAll('[required]');
        if (show) {
            detalhesGraduacaoDiv.classList.remove('hidden-field');
            registrosEntidadesDiv.classList.remove('hidden-field');
            requiredFields.forEach(f => f.setAttribute('required', 'required'));
        } else {
            detalhesGraduacaoDiv.classList.add('hidden-field');
            registrosEntidadesDiv.classList.add('hidden-field');
            requiredFields.forEach(f => f.removeAttribute('required'));
        }
    }

    arteMarcialSelect.addEventListener('change', function() {
        const selectedArt = this.value;
        corFaixaSelect.innerHTML = '<option value="">Selecione a cor</option>';
        corFaixaSelect.disabled = true;

        if (selectedArt && graduacoes[selectedArt]) {
            corFaixaSelect.disabled = false;
            graduacoes[selectedArt].forEach(faixa => {
                const option = document.createElement('option');
                option.value = faixa;
                option.textContent = faixa;
                corFaixaSelect.appendChild(option);
            });
        }
        
        // Reseta os campos dependentes
        corFaixaSelect.dispatchEvent(new Event('change'));
    });

    corFaixaSelect.addEventListener('change', function() {
        const selectedFaixa = this.value;
        const isJiuJitsu = arteMarcialSelect.value === 'jiu-jitsu';

        if (selectedFaixa.includes('Branca')) {
            nivelFaixaBrancaContainer.classList.remove('hidden-field');
            toggleDetalhes(nivelFaixaBrancaSelect.value === 'iniciante-ja-treinei');
        } else {
            nivelFaixaBrancaContainer.classList.add('hidden-field');
            toggleDetalhes(!!selectedFaixa);
        }
        
        grauContainer.classList.add('hidden-field');
        grauSelect.innerHTML = '';
        if (isJiuJitsu) {
            let grauOptions = null;
            if (['Branca', 'Cinza', 'Amarela', 'Laranja', 'Verde', 'Azul', 'Roxa', 'Marrom'].some(cor => selectedFaixa.includes(cor))) {
                grauOptions = grausJiuJitsuBasico;
            } else if (selectedFaixa.includes('Preta')) {
                grauOptions = grausJiuJitsuPreta;
            }

            if (grauOptions) {
                grauOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    grauSelect.appendChild(option);
                });
                grauContainer.classList.remove('hidden-field');
            }
        }
    });

    nivelFaixaBrancaSelect.addEventListener('change', function() {
        toggleDetalhes(this.value === 'iniciante-ja-treinei');
    });
    
    medicamentoRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            medicamentoDescricaoContainer.classList.toggle('hidden-field', this.value !== 'sim');
        });
    });

    // --- LÓGICA DE ADICIONAR/REMOVER REGISTRO DE ENTIDADE (MELHORADA) ---
    addEntidadeBtn.addEventListener('click', function() {
        const template = document.getElementById('entidadeTemplate');
        const clone = template.content.cloneNode(true);
        const currentId = entidadeCounter;

        // Garante que IDs e 'for' sejam únicos
        clone.querySelectorAll('[id]').forEach(element => {
            element.id = `${element.id}_${currentId}`;
        });
        clone.querySelectorAll('label[for]').forEach(label => {
            label.htmlFor = `${label.htmlFor}_${currentId}`;
        });
        // Garante que o grupo de radio buttons seja único para cada bloco
        clone.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.name = `entidadeAtivo_${currentId}`;
        });
        
        registrosContainer.appendChild(clone);
        entidadeCounter++;
    });

    registrosContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-button')) {
            e.target.closest('.entidade-registro-block').remove();
        }
    });

    // --- CÁLCULO DE IDADE E IMC (sem alterações) ---
    document.getElementById("dataNascimento").addEventListener('change', function() {
        const idadeInput = document.getElementById("idade");
        if (this.value) {
            const birthDate = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            idadeInput.value = age >= 0 ? age : "";
        } else {
            idadeInput.value = "";
        }
    });

    const alturaInput = document.getElementById("altura");
    const pesoInput = document.getElementById("peso");
    const imcInput = document.getElementById("imc");
    const imcResultDiv = document.getElementById('imcResult');
    const imcClassificationSpan = document.getElementById('imcClassification');
    const imcRiskSpan = document.getElementById('imcRisk');

    function calcularIMC() {
        const alturaStr = alturaInput.value.replace(',', '.');
        const pesoStr = pesoInput.value.replace(',', '.');
        let altura = parseFloat(alturaStr);
        const peso = parseFloat(pesoStr);

        if (altura > 3) altura = altura / 100;

        if (altura > 0 && peso > 0) {
            const imc = peso / (altura * altura);
            imcInput.value = imc.toFixed(2);

            let classification = '', risk = '', resultClass = '';
            if (imc < 18.5) { classification = 'Magreza'; risk = 'Baixo'; resultClass = 'imc-atencao'; } 
            else if (imc <= 24.9) { classification = 'Peso adequado'; risk = 'Médio'; resultClass = 'imc-normal'; } 
            else if (imc <= 29.9) { classification = 'Sobrepeso'; risk = 'Pouco Elevado'; resultClass = 'imc-atencao'; } 
            else if (imc <= 34.9) { classification = 'Obesidade Grau I'; risk = 'Elevado'; resultClass = 'imc-alerta'; } 
            else if (imc <= 39.9) { classification = 'Obesidade Grau II'; risk = 'Muito Elevado'; resultClass = 'imc-alerta'; } 
            else { classification = 'Obesidade Grau III'; risk = 'Muitíssimo Elevado'; resultClass = 'imc-alerta'; }
            
            imcClassificationSpan.textContent = classification;
            imcRiskSpan.textContent = risk;

            const resultBox = imcResultDiv.querySelector('.imc-result-box');
            resultBox.className = 'imc-result-box ' + resultClass;
            imcResultDiv.classList.remove('hidden-field');
        } else {
            imcInput.value = "";
            imcResultDiv.classList.add('hidden-field');
        }
    }

    alturaInput.addEventListener('input', calcularIMC);
    pesoInput.addEventListener('input', calcularIMC);
});
</script>
<script>
    (function(){
        // ---- Validador de CPF (local, sem API externa) ----
        function validarCPF(cpf){
            if(!cpf) return false;
            const num = String(cpf).replace(/\D/g,'');
            if(num.length!==11) return false;
            if(/^(\d)\1{10}$/.test(num)) return false; // todos iguais
            const calc = (b)=>{let s=0;for(let i=0;i<b;i++) s+=parseInt(num[i],10)*(b+1-i);const r=(s*10)%11;return r===10?0:r;};
            const d1 = calc(9), d2 = calc(10);
            return d1===parseInt(num[9],10) && d2===parseInt(num[10],10);
        }

        // pega o FORM e o campo CPF
        const form = document.querySelector('form#formCadastro') || document.querySelector('form');
        const cpfEl = document.getElementById('cpf');
        const msgEl = document.getElementById('cpfErro'); // pode ser null se você não criou o <small>

        if(!form || !cpfEl) return;

        // máscara enquanto digita (000.000.000-00)
        cpfEl.addEventListener('input', () => {
            const pos = cpfEl.selectionStart || 0;
            cpfEl.value = String(cpfEl.value)
                .replace(/\D/g,'')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2')
                .slice(0,14);
            cpfEl.setSelectionRange(pos, pos);
        });

        // valida na hora de enviar
        form.addEventListener('submit', function(e){
            const ok = validarCPF(cpfEl.value);
            if(!ok){
                e.preventDefault();
                cpfEl.style.borderColor = '#ff4d4f';
                if (msgEl) msgEl.textContent = 'CPF inválido. Verifique e tente novamente.';
                else alert('CPF inválido. Verifique e tente novamente.');
                cpfEl.focus();
            } else {
                cpfEl.style.borderColor = '';
                if (msgEl) msgEl.textContent = '';
            }
        });
    })();
</script>
<script>
    (function(){
        const cpfEl = document.getElementById('cpf');
        const msgEl = document.getElementById('cpfErro');
        if (!cpfEl || !msgEl) return;

        function validarCPF(cpf){
            if(!cpf) return false;
            const num = String(cpf).replace(/\D/g,'');
            if (num.length !== 11) return false;
            if (/^(\d)\1{10}$/.test(num)) return false;
            const calc = (b)=>{ let s=0; for (let i=0;i<b;i++) s += parseInt(num[i],10)*(b+1-i);
                const r = (s*10)%11; return r===10?0:r; };
            const d1 = calc(9), d2 = calc(10);
            return d1===parseInt(num[9],10) && d2===parseInt(num[10],10);
        }

        function aplicarMascara(){
            const pos = cpfEl.selectionStart || 0;
            cpfEl.value = String(cpfEl.value)
                .replace(/\D/g,'')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2')
                .slice(0,14);
            cpfEl.setSelectionRange(pos, pos);
        }

        function atualizarMensagem(){
            const puro = cpfEl.value.replace(/\D/g,'');
            if (puro.length < 11) {
                msgEl.textContent = '';
                msgEl.style.display = 'none';
                cpfEl.style.borderColor = '';
                return;
            }
            const ok = validarCPF(cpfEl.value);
            if (ok) {
                msgEl.classList.remove('erro-campo');
                msgEl.classList.add('ok-campo');
                msgEl.textContent = 'CPF válido.';
                msgEl.style.display = 'block';
                msgEl.style.color = '#16a34a';   // <— força VERDE
                cpfEl.style.borderColor = '';
            } else {
                msgEl.classList.remove('ok-campo');
                msgEl.classList.add('erro-campo');
                msgEl.textContent = 'CPF inválido. Verifique e tente novamente.';
                msgEl.style.display = 'block';
                msgEl.style.color = '#d22';      // <— força VERMELHO
                cpfEl.style.borderColor = '#ff4d4f';
            }
        }

        cpfEl.addEventListener('input', function(){
            aplicarMascara();
            atualizarMensagem();
        });

        // roda uma vez ao carregar (se já tiver valor)
        aplicarMascara();
        atualizarMensagem();
    })();
</script>
<script src="../../shared/js/auth.js"></script>
<script>
    (() => {
        const btn   = document.getElementById('cameraButton');
        const video = document.getElementById('cameraPreview');

        if (!btn || !video) {
            alert('IDs não encontrados: cameraButton / cameraPreview');
            return;
        }

        let stream = null;

        btn.addEventListener('click', async () => {
            try {
                // encerra stream anterior, se houver
                if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

                console.log('Solicitando getUserMedia...');
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });

                console.log('getUserMedia OK:', stream);
                video.srcObject = stream;
                video.style.display = 'block';
                video.setAttribute('playsinline', '');  // iOS-friendly
                btn.textContent = 'Câmera ligada';
                alert('CÂMERA OK (permissões e hardware funcionando)');
            } catch (err) {
                console.error('Erro getUserMedia:', err.name, err.message);
                alert('Falhou: ' + err.name + ' - ' + err.message);
            }
        });
    })();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form             = document.getElementById('formCadastro') || document.querySelector('form');
        const video            = document.getElementById('cameraPreview');
        const img              = document.getElementById('previewImage');
        const btnOpen          = document.getElementById('cameraButton');
        const btnShot          = document.getElementById('captureButton');
        const btnConfirm       = document.getElementById('photoSubmitButton');

        let stream = null;
        let lastDataUrl = null;

        // Quando clicar em "Abrir Câmera", garanta que o botão "Tirar Foto" apareça
        btnOpen?.addEventListener('click', () => {
            if (btnShot)      btnShot.style.display = 'inline-block';
            if (btnConfirm)   btnConfirm.style.display = 'none';
            if (img)          img.style.display = 'none';
            if (video)        video.style.display = 'block';
        });

        // Tirar foto do vídeo
        btnShot?.addEventListener('click', () => {
            if (!video || !video.srcObject) {
                alert('Abra a câmera primeiro.');
                return;
            }

            const w = video.videoWidth || 800;
            const h = video.videoHeight || 600;
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);

            // Gera imagem (base64)
            lastDataUrl = canvas.toDataURL('image/jpeg', 0.92);

            // Mostra a prévia
            if (img) {
                img.src = lastDataUrl;
                img.style.display = 'block';
            }

            // Alterna a UI
            if (video) {
                // libera a câmera
                try { video.srcObject?.getTracks().forEach(t => t.stop()); } catch(e) {}
                video.srcObject = null;
                video.style.display = 'none';
            }
            if (btnShot)    btnShot.style.display = 'none';
            if (btnConfirm) btnConfirm.style.display = 'inline-block';
        });

        // Confirmar foto: salva em um input hidden para ir junto do formulário
        btnConfirm?.addEventListener('click', () => {
            if (!lastDataUrl && img?.src) lastDataUrl = img.src;
            if (!lastDataUrl) {
                alert('Tire ou selecione uma foto antes de confirmar.');
                return;
            }
            let hidden = document.getElementById('photoData');
            if (!hidden) {
                hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.id = 'photoData';
                hidden.name = 'photoData';
                form?.appendChild(hidden);
            }
            hidden.value = lastDataUrl; // base64 da imagem

            // Feedback visual rápido
            const old = btnConfirm.textContent;
            btnConfirm.textContent = 'Foto confirmada ✓';
            setTimeout(() => { btnConfirm.textContent = old; }, 1500);
        });
    });
</script>
</body>
</html>