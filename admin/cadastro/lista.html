<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alunos • Lista</title>
  <style>
    :root{
      --bg:#0c0f14; --ink:#eaeaea; --line:#1f2530;
      --card:#111827; --thead:#0f141b;
      --btn-bg:#111827; --btn-br:#334155; --btn-ink:#bfdbfe; --btn-hover:#1e293b;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--line)}
    main{padding:16px 24px}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:#9ad1ff;text-align:left;background:var(--thead)}
    tr:last-child td{border-bottom:0}
    a.btn{color:#60a5fa;text-decoration:none}
    .muted{opacity:.7}

    .btn-back{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.55rem .9rem;background:var(--btn-bg);
      border:1px solid var(--btn-br);border-radius:.6rem;
      color:var(--btn-ink);text-decoration:none;line-height:1
    }
    .btn-back:hover{background:var(--btn-hover)}
    .chevron{font-weight:600}

    /* Caixinha do link curto */
    #inviteLinkBox{
      margin-top:12px;
      background:#0b1220;
      border:1px solid #223047;
      border-radius:10px;
      padding:10px;
      display:none; /* começa escondida */
    }
    #inviteLinkBox label{
      color:#9be28d;font-weight:600;margin-bottom:6px;display:block;
    }
    #inviteLinkBox input{
      flex:1;min-width:0;background:#0e1830;
      border:1px solid #2a3d60;border-radius:8px;
      padding:8px;color:#cfe7ff;
    }
    #inviteCopyBtn{
      white-space:nowrap;background:#16a34a;
      border:1px solid #12813c;color:white;
      border-radius:8px;padding:8px 12px;cursor:pointer;
      
    }
  </style>

  <link rel="stylesheet" href="/admin/css/invite-modal.css?v=nudge1">
  <link rel="stylesheet" href="/admin/css/invite-nudge.css?v=2">
  <link rel="stylesheet" href="/admin/css/invite-tiny.css">
</head>
<body>
<header>
  <h1>Alunos • Lista</h1>
  <a class="btn-back" href="/admin/index.html"><span class="chevron">←</span> Voltar ao Admin</a>
</header>

<main>
  <div class="admin-toolbar">
    <button id="btnInvite" class="btn btn-primary" type="button" aria-label="Enviar convite">
      ✉️  Enviar convite
    </button>
  </div>

  <table aria-describedby="tableHint">
    <thead>
    <tr>
      <th>Nome</th>
      <th>Email</th>
      <th>Telefone</th>
      <th>Nº Cadastro</th>
      <th>Criado</th>
      <th></th>
    </tr>
    </thead>
    <tbody id="tb">
    <tr><td class="muted" colspan="6">Carregando…</td></tr>
    </tbody>
  </table>
  <p id="tableHint" class="muted" style="margin:.6rem 0 0">Use “Editar” para alterar um cadastro.</p>
</main>

<script>
  function fmtData(v){
    if(!v) return '';
    const d = new Date(v);
    return isNaN(d) ? '' : d.toLocaleString();
  }

  async function load(){
    const tb = document.getElementById('tb');
    try{
      const r = await fetch('/api/alunos/list');
      const j = await r.json().catch(()=> ({}));
      const rows = j.data || j.rows || [];

      if(!Array.isArray(rows) || rows.length === 0){
        tb.innerHTML = '<tr><td class="muted" colspan="6">Nenhum aluno encontrado.</td></tr>';
        return;
      }

      tb.innerHTML = '';
      rows.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.nome ?? ''}</td>
          <td>${a.email ?? ''}</td>
          <td>${a.telefone ?? ''}</td>
          <td><code>${a.cad_numero ?? ''}</code></td>
          <td>${fmtData(a.created_at)}</td>
          <td><a class="btn" href="/admin/cadastro/editar.html?id=${encodeURIComponent(a.id)}">Editar</a></td>
        `;
        tb.appendChild(tr);
      });
    }catch(e){
      tb.innerHTML = '<tr><td class="muted" colspan="6">Falha ao carregar a lista.</td></tr>';
    }
  }
  document.addEventListener('DOMContentLoaded', load);
</script>

<!-- MANTÉM apenas o script que constrói/abre o modal -->
<script src="/shared/js/invite-rebuild.js"></script>

<!-- Modal de convite -->
<div class="kkr-modal-backdrop" id="kkrInviteBackdrop" aria-hidden="true"></div>
<div class="kkr-modal" id="kkrInviteModal" role="dialog" aria-labelledby="kkrInviteTitle" hidden>
  <div class="kkr-card">
    <h3 id="kkrInviteTitle">Enviar convite</h3>
    <p class="sub">Preencha os dados básicos; o aluno recebe o link para completar o cadastro.</p>

    <div class="kkr-field"><label>Nome*</label><input id="invNome" placeholder="Nome do aluno" required></div>
    <div class="kkr-field"><label>E-mail*</label><input id="invEmail" placeholder="email@exemplo.com" required></div>
    <div class="kkr-field"><label>Telefone</label><input id="invFone" placeholder="(DDD) 99999-9999"></div>
    <div class="kkr-field"><label>WhatsApp/Telegram</label><input id="invApp" placeholder="WhatsApp/Telegram (opcional)"></div>
    <div class="kkr-field"><label>Observações</label><textarea id="invObs" rows="3" placeholder="Observações (opcional)"></textarea></div>

    <!-- Caixinha do link curto -->
    <div id="inviteLinkBox">
      <label>Link gerado:</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="inviteShortLink" type="text" readonly value="">
        <button id="inviteCopyBtn" type="button">Copiar link</button>
      </div>
    </div>

    <div class="kkr-actions">
      <button class="kkr-btn secondary" id="invCancel">Cancelar</button>
      <button class="kkr-btn primary" id="invSend" disabled>Gerar link + enviar</button>
    </div>
  </div>
</div>

<!-- Habilita o botão quando nome e e-mail estiverem preenchidos -->
<script>
  (function(){
    const nome  = document.getElementById('invNome');
    const email = document.getElementById('invEmail');
    const send  = document.getElementById('invSend');
    function toggle(){ send.disabled = !(nome.value.trim() && email.value.trim()); }
    if (nome && email && send){
      nome.addEventListener('input', toggle);
      email.addEventListener('input', toggle);
      toggle();
    }
  })();
</script>

<!-- Script que gera o token curto e preenche a caixinha -->
<script>
  (function(){
    const sendBtn = document.getElementById('invSend');
    const box     = document.getElementById('inviteLinkBox');
    const input   = document.getElementById('inviteShortLink');
    const copyBtn = document.getElementById('inviteCopyBtn');

    // Esconde qualquer linha “Link gerado: …” antiga que algum script coloque
    const modal = document.getElementById('kkrInviteModal');
    const hideOldShareLines = () => {
      if (!modal) return;
      modal.querySelectorAll('p,div,span,code').forEach(el=>{
        const t = (el.textContent || '').trim();
        if (t.startsWith('Link gerado:') && /https?:\/\//.test(t)) el.style.display='none';
      });
    };
    const obs = new MutationObserver(hideOldShareLines);
    obs.observe(modal, {childList:true,subtree:true,characterData:true});

    async function criarConvite(){
      const nome  = document.getElementById('invNome').value.trim();
      const email = document.getElementById('invEmail').value.trim();
      const fone  = document.getElementById('invFone').value.trim();
      const wa    = document.getElementById('invApp').value.trim();
      const obsrv = document.getElementById('invObs').value.trim();

      if(!nome || !email) return;

      // feedback visual
      const oldLabel = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Gerando…';

      try{
        const r = await fetch('/api/convites/criar', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            nome, email,
            telefone: fone || null,
            whatsapp: wa || null,
            obs: obsrv || null
          })
        });
        const j = await r.json().catch(()=> ({}));

        if(!j.ok){
          alert('Falha ao gerar convite: ' + (j.error || 'erro desconhecido'));
          return;
        }

        // usa j.url se vier; senão monta a partir do token
        const url = j.url || (location.origin + '/cadastro.html?token=' + encodeURIComponent(j.token) + '&email=' + encodeURIComponent(email));
        input.value = url;
        box.style.display = 'block';
        hideOldShareLines(); // esconde a linha comprida

      }catch(e){
        alert('Erro inesperado ao criar convite.');
      }finally{
        sendBtn.textContent = oldLabel;
        sendBtn.disabled = false;
      }
    }

    if (sendBtn){
      sendBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        criarConvite();
      });
    }

    if (copyBtn){
      copyBtn.addEventListener('click', async ()=>{
        if(!input.value) return;
        try{
          await navigator.clipboard.writeText(input.value);
          const old = copyBtn.textContent;
          copyBtn.textContent = 'Copiado!';
          setTimeout(()=> copyBtn.textContent = old, 1200);
        }catch(_){
          input.select(); document.execCommand('copy');
        }
      });
    }
  })();
</script>
<script>
  (() => {
    // cria a caixinha se ainda não existir
    function ensureBox() {
      let box = document.getElementById('inviteLinkBox');
      if (box) return box;

      const card = document.querySelector('#kkrInviteModal .kkr-card');
      if (!card) return null;

      box = document.createElement('div');
      box.id = 'inviteLinkBox';
      box.style.cssText = 'display:none;margin-top:12px;background:#0b1220;border:1px solid #223047;border-radius:10px;padding:10px';

      box.innerHTML = `
      <label style="color:#9be28d;font-weight:600;margin-bottom:6px;display:block">Link gerado:</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="inviteShortLink" type="text" readonly value=""
               style="flex:1;min-width:0;background:#0e1830;border:1px solid #2a3d60;border-radius:8px;padding:8px;color:#cfe7ff;font-size:.85rem">
        <button id="inviteCopyBtn" type="button"
                style="white-space:nowrap;background:#16a34a;border:1px solid #12813c;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer">
          Copiar link
        </button>
      </div>
    `;
      // insere a caixinha logo DEPOIS da área de Observações
      const obs = document.getElementById('invObs');
      if (obs && obs.closest('.kkr-field')) {
        obs.closest('.kkr-field').after(box);
      } else {
        card.appendChild(box);
      }

      // copiar para área de transferência
      const btn = box.querySelector('#inviteCopyBtn');
      btn.addEventListener('click', async () => {
        const inp = box.querySelector('#inviteShortLink');
        if (!inp.value) return;
        try {
          await navigator.clipboard.writeText(inp.value);
          const old = btn.textContent; btn.textContent = 'Copiado!';
          setTimeout(() => btn.textContent = old, 1200);
        } catch {
          inp.select(); document.execCommand('copy');
          const old = btn.textContent; btn.textContent = 'Copiado!';
          setTimeout(() => btn.textContent = old, 1200);
        }
      });

      return box;
    }

    // acha a linha antiga "Link gerado: https://..."
    function findLongLine() {
      const card = document.querySelector('#kkrInviteModal .kkr-card');
      if (!card) return null;
      const nodes = card.querySelectorAll('p,div,span');
      for (const el of nodes) {
        if (el.id === 'inviteLinkBox' || el.closest('#inviteLinkBox')) continue;
        const t = (el.textContent || '').trim();
        if (t.startsWith('Link gerado:') && /https?:\/\/\S+/.test(t)) return el;
      }
      return null;
    }

    // move a URL para a caixinha e esconde a linha antiga
    function adoptUrl() {
      const line = findLongLine();
      if (!line) return;
      const m = line.textContent.match(/(https?:\/\/\S+)/);
      if (!m) return;
      const url = m[1];

      const box = ensureBox();
      if (!box) return;

      box.querySelector('#inviteShortLink').value = url;
      box.style.display = 'block';
      line.style.display = 'none';
    }

    // observa mudanças no modal (o link é inserido de forma dinâmica)
    const modal = document.getElementById('kkrInviteModal');
    if (!modal) return;
    const obs = new MutationObserver(adoptUrl);
    obs.observe(modal, { childList:true, subtree:true, characterData:true });

    // também tenta capturar logo após clicar no botão "Gerar link + enviar"
    document.addEventListener('click', (ev) => {
      if (ev.target && ev.target.closest('#invSend')) {
        setTimeout(adoptUrl, 120);
      }
    }, true);
  })();
</script>
</body>
</html>