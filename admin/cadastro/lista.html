<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alunos • Lista</title>
  <style>
    :root{
      --bg:#0c0f14; --ink:#eaeaea; --line:#1f2530;
      --card:#111827; --thead:#0f141b;
      --btn-bg:#111827; --btn-br:#334155; --btn-ink:#bfdbfe; --btn-hover:#1e293b;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--line)}
    main{padding:16px 24px}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:#9ad1ff;text-align:left;background:var(--thead)}
    tr:last-child td{border-bottom:0}
    a.btn{color:#60a5fa;text-decoration:none}
    .muted{opacity:.7}

    /* Botão-link de voltar – um único <a> */
    .btn-back{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.55rem .9rem;background:var(--btn-bg);
      border:1px solid var(--btn-br);border-radius:.6rem;
      color:var(--btn-ink);text-decoration:none;line-height:1
    }
    .btn-back:hover{background:var(--btn-hover)}
    .chevron{font-weight:600}
  </style>
</head>
  <link rel="stylesheet" href="/admin/css/invite-modal.css">
<body>
<header>
  <h1>Alunos • Lista</h1>
  <!-- UM ÚNICO LINK estilizado como botão (sem <a> dentro de <a>) -->
  <a class="btn-back" href="/admin/index.html"><span class="chevron">←</span> Voltar ao Admin</a>
</header>

<main>
  <div class="admin-toolbar">
    <button id="btnInvite" class="btn btn-primary" type="button" aria-label="Enviar convite">
      ✉️  Enviar convite
    </button>
  </div>
  <table aria-describedby="tableHint">
    <thead>
    <tr>
      <th>Nome</th>
      <th>Email</th>
      <th>Telefone</th>
      <th>Nº Cadastro</th>
      <th>Criado</th>
      <th></th>
    </tr>
    </thead>
    <tbody id="tb">
    <tr><td class="muted" colspan="6">Carregando…</td></tr>
    </tbody>
  </table>
  <p id="tableHint" class="muted" style="margin:.6rem 0 0">Use “Editar” para alterar um cadastro.</p>
</main>

<script>
  function fmtData(v){
    if(!v) return '';
    const d = new Date(v);
    return isNaN(d) ? '' : d.toLocaleString();
  }

  async function load(){
    const tb = document.getElementById('tb');
    try{
      const r = await fetch('/api/alunos/list');
      const j = await r.json().catch(()=> ({}));
      const rows = j.data || j.rows || [];

      if(!Array.isArray(rows) || rows.length === 0){
        tb.innerHTML = '<tr><td class="muted" colspan="6">Nenhum aluno encontrado.</td></tr>';
        return;
      }

      tb.innerHTML = '';
      rows.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${a.nome ?? ''}</td>
            <td>${a.email ?? ''}</td>
            <td>${a.telefone ?? ''}</td>
            <td><code>${a.cad_numero ?? ''}</code></td>
            <td>${fmtData(a.created_at)}</td>
            <td><a class="btn" href="/admin/cadastro/editar.html?id=${encodeURIComponent(a.id)}">Editar</a></td>
          `;
        tb.appendChild(tr);
      });
    }catch(e){
      tb.innerHTML = '<tr><td class="muted" colspan="6">Falha ao carregar a lista.</td></tr>';
    }
  }

  document.addEventListener('DOMContentLoaded', load);
</script>
</body>
  <script src="/shared/js/invite-fix.js"></script>
  <div class="kkr-modal-backdrop" id="kkrInviteBackdrop" aria-hidden="true"></div>
  <div class="kkr-modal" id="kkrInviteModal" role="dialog" aria-modal="true" aria-labelledby="kkrInviteTitle" hidden>
    <div class="kkr-card">
      <h3 id="kkrInviteTitle">Enviar convite</h3>
      <p class="sub">Preencha os dados básicos; o aluno recebe o link para completar o cadastro.</p>
      <div class="kkr-field"><label>Nome*</label><input id="invNome" placeholder="Nome do aluno" required></div>
      <div class="kkr-field"><label>E-mail*</label><input id="invEmail" placeholder="email@exemplo.com" required></div>
      <div class="kkr-field"><label>Telefone</label><input id="invFone" placeholder="(DDD) 99999-9999"></div>
      <div class="kkr-field"><label>WhatsApp/Telegram</label><input id="invApp" placeholder="WhatsApp/Telegram (opcional)"></div>
      <div class="kkr-field"><label>Observações</label><textarea id="invObs" rows="3" placeholder="Observações (opcional)"></textarea></div>
      <div class="kkr-actions">
        <button class="kkr-btn secondary" id="invCancel">Cancelar</button>
        <button class="kkr-btn primary" id="invSend" disabled>Enviar</button>
      </div>
    </div>
  </div>
  <script src="/shared/js/invite-widget.js"></script>
</html>
<script id="kkrInviteSuperFix">
(function(){
  function ensureInvite(){
    // 1) Acha (ou cria) o botão
    var btn = document.querySelector("#btnInvite,[data-action=invite-open]");
    if(!btn){
      btn = document.createElement("button");
      btn.id = "btnInvite";
      btn.dataset.action = "invite-open";
      btn.type = "button";
      btn.className = "btn btn-primary kkr-invite-btn";
      btn.innerHTML = "&#128233; Enviar convite";
      var h1 = document.querySelector("h1") || document.body;
      if(h1 && h1.parentNode){
        if(h1.nextSibling) h1.parentNode.insertBefore(btn, h1.nextSibling);
        else h1.parentNode.appendChild(btn);
      } else { document.body.appendChild(btn); }
    }

    // 2) Função para abrir o modal
    function openModal(){
      try{
        if(window.kkrInvite && typeof window.kkrInvite.show === "function"){
          window.kkrInvite.show();
          return;
        }
      }catch(_){}
      // fallback: dispara um evento que seu script do modal pode ouvir
      document.dispatchEvent(new CustomEvent("kkr:invite:open"));
    }

    // 3) Listener direto
    btn.addEventListener("click", function(ev){ ev.preventDefault(); openModal(); });

    // 4) Delegação global (se o botão for re-renderizado)
    document.addEventListener("click", function(ev){
      var t = ev.target && ev.target.closest ? ev.target.closest("#btnInvite,[data-action=invite-open]") : null;
      if(t){ ev.preventDefault(); openModal(); }
    });

    // 5) Estilo mínimo (margem + z-index do modal)
    var css = ".kkr-invite-btn{margin-left:24px;margin-top:8px}"+
              ".invite-modal{z-index:9999}";
    var st = document.createElement("style"); st.textContent = css; document.head.appendChild(st);
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ensureInvite);
  } else {
    ensureInvite();
  }
  window.addEventListener("pageshow", ensureInvite);
})();
</script>
