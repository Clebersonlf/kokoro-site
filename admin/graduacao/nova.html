<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adicionar Graduação</title>

  <link rel="stylesheet" href="/css/style.css">

  <style>
    :root{
      --bg:#0c0f14; --panel:#151515; --border:#222; --ink:#e5e7eb;
      --muted:#9ca3af; --brand:#8ecbff; --btn-bg:#111827; --btn-br:#334155; --btn-hover:#1e293b;
    }
    body{background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Arial; margin:0}

    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}

    /* Botões (link estilizado) */
    .btn{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.55rem .9rem; background:var(--btn-bg);
      border:1px solid var(--btn-br); border-radius:.6rem;
      color:#bfdbfe; text-decoration:none; line-height:1
    }
    .btn:hover{background:var(--btn-hover)}
    .chevron{font-weight:600}

    .form{background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:16px}
    label{display:block;margin-top:10px;color:#9ad1ff}
    input,select{
      width:100%;padding:10px;border:1px solid #333;background:#202020;color:#eee;border-radius:8px
    }
    button{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;margin-top:14px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- TOPO: APENAS UM LINK POR BOTÃO -->
  <div class="top">
    <a class="btn" href="/admin/cadastro/lista.html"><span class="chevron">←</span> Voltar à Lista</a>
    <a class="btn" href="/admin/index.html"><span class="chevron">←</span> Voltar ao Admin</a>
  </div>

  <div class="form">
    <h2 style="color:#9ad1ff">Adicionar Graduação</h2>
    <p>Nº automático é sugerido a partir de <b>0074</b>. Para faixas reservadas (0000–0073), digite manualmente.</p>

    <label>Aluno</label>
    <select id="aluno"></select>

    <label>Nº (opcional)</label>
    <input id="numero" placeholder="deixe em branco para auto (>= 0074)">

    <label>Faixa</label>
    <input id="faixa" list="faixas" placeholder="ex.: Roxa / Marrom / Preta" autocomplete="on">

    <datalist id="faixas">
      <option value="Faixa Branca">
      <option value="Faixa Cinza e Branca">
      <option value="Faixa Cinza">
      <option value="Faixa Cinza e Preta">
      <option value="Faixa Amarela e Branca">
      <option value="Faixa Amarela">
      <option value="Faixa Amarela e Preta">
      <option value="Laranja e Branca">
      <option value="Laranja">
      <option value="Laranja e Preta">
      <option value="Verde e Branca">
      <option value="Verde">
      <option value="Verde e Preta">
      <option value="Faixa Azul">
      <option value="Faixa Roxa">
      <option value="Faixa Marrom">
      <option value="Faixa Preta Lisa (Instrutor)">
      <option value="Faixa Preta (1º Grau) Instrutor">
      <option value="Faixa Preta (2º Grau) Professor">
      <option value="Faixa Preta (3º Grau) Professor">
      <option value="Faixa Preta (4º Grau) Professor">
      <option value="Faixa Preta (5º Grau) Professor">
      <option value="Faixa Preta (6º Grau) Professor">
      <option value="Faixa Vermelha e Preta (7º Grau) Mestre">
      <option value="Faixa Vermelha e Branca (8º Grau) Grande Mestre">
      <option value="Faixa Vermelha (9º Grau) Grão Mestre">
      <option value="Faixa Vermelha (10º Grau) Venerável Mestre">
    </datalist>

    <label>Data</label>
    <input id="data" type="date">

    <button onclick="salvar()">Salvar</button>
  </div>
</div>

<script>
  async function carregarAlunos(){
    const sel = document.getElementById('aluno');
    sel.innerHTML = '<option>Carregando…</option>';
    try{
      const r = await fetch('/api/alunos');
      const js = await r.json();
      sel.innerHTML = (js.ok ? js.data : [])
              .map(a => `<option value="${a.id}">${a.nome} (${a.email})</option>`)
              .join('') || '<option value="">(sem alunos)</option>';
    }catch(e){
      sel.innerHTML = '<option value="">(erro ao carregar)</option>';
    }
  }

  async function salvar(){
    const aluno_id = document.getElementById('aluno').value;
    const numero   = (document.getElementById('numero').value || '').trim();
    const faixa    = (document.getElementById('faixa').value || '').trim();
    const data     = document.getElementById('data').value || null;

    if(!aluno_id){ alert('Selecione um aluno'); return; }

    const r = await fetch('/api/graduacoes', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        aluno_id,
        grad_numero: numero || undefined,
        faixa,
        data_graduacao: data || undefined
      }),
    });
    const js = await r.json();
    if(!js.ok){ alert(js.message || 'Falha ao salvar'); return; }
    window.location.href = '/admin/graduacao/lista.html';
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const d = new Date();
    document.getElementById('data').value = d.toISOString().slice(0,10);
    carregarAlunos();
  });
</script>
</body>
</html>