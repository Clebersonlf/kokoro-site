<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Admin — Enviar convite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:720px;margin:20px auto;padding:0 12px;}
    label{display:block;margin:10px 0 4px}
    input{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{margin-top:16px;display:flex;gap:12px;align-items:center}
    .ok{color:#0a0}.err{color:#c00}
    .links a{display:inline-block;margin:6px 6px 0 0}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
  </style>
</head>
<body>
  <h1>Admin — Enviar convite</h1>
  <p>Preencha no mínimo <b>e-mail</b> (telefone é opcional). O sistema cria/atualiza o aluno como <i>pendente</i> e gera o link de completar cadastro.</p>

  <div id="msg"></div>

  <div class="card">
    <label>Nome (opcional)
      <input id="nome" placeholder="Ex.: João Silva">
    </label>
    <div class="row">
      <div>
        <label>E-mail (recomendado)
          <input id="email" type="email" placeholder="exemplo@dominio.com">
        </label>
      </div>
      <div>
        <label>Telefone (só números, com DDI+DDD, opcional)
          <input id="telefone" placeholder="559999999999">
        </label>
      </div>
    </div>
    <div class="actions">
      <button id="btnEnviar">Gerar convite</button>
      <span id="status"></span>
    </div>
  </div>

  <div id="resultado" class="card" style="display:none">
    <h3>Convite gerado</h3>
    <div><b>Link:</b> <a id="lk" href="#" target="_blank"></a></div>
    <div class="links">
      <a id="lkWa" target="_blank">Abrir WhatsApp</a>
      <a id="lkTg" target="_blank">Abrir Telegram</a>
      <a id="lkSms" target="_blank">Abrir SMS</a>
      <a id="lkMail" target="_blank">Abrir e-mail</a>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const msg = $('#msg'); const st = $('#status');
    function setMsg(t, ok=false){ msg.className = ok?'ok':'err'; msg.textContent = t||''; }
    function setSt (t, ok=false){ st.className  = ok?'ok':'err'; st.textContent  = t||''; }

    $('#btnEnviar').addEventListener('click', async () => {
      setSt('Enviando...', true);
      const nome = $('#nome').value.trim() || null;
      const email = $('#email').value.trim() || null;
      const telefone = $('#telefone').value.replace(/\\D/g,'') || null;

      if (!email) { setSt('Informe ao menos o e-mail.', false); return; }

      try {
        const r = await fetch('/api/send-welcome', {
          method: 'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome, email, telefone, via:'email' })
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data.ok) { setSt(data.message || 'Falha ao gerar convite.', false); return; }

        setSt('Convite gerado.', true);
        const rs = $('#resultado'); rs.style.display = '';
        $('#lk').href = data.link; $('#lk').textContent = data.link;

        const sug = data.delivery?.suggestions || {};
        $('#lkWa').href  = sug.whatsapp || '#';  $('#lkWa').style.opacity  = sug.whatsapp ? 1 : .5;
        $('#lkTg').href  = sug.telegram || '#';  $('#lkTg').style.opacity  = sug.telegram ? 1 : .5;
        $('#lkSms').href = sug.sms || '#';       $('#lkSms').style.opacity = sug.sms ? 1 : .5;
        $('#lkMail').href= sug.mailto || '#';    $('#lkMail').style.opacity= sug.mailto ? 1 : .5;

      } catch(e){ setSt('Erro de conexão.', false); }
    });
  </script>
  <script src="/admin/_session_timer.js" defer></script>
</body>
</html>
