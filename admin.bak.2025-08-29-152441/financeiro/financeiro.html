<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KOKORO ÂøÉ - Controle Financeiro (v2)</title>
    <style>
        :root {
            --cor-fundo: #121212; --cor-container: #1a1a1a; --cor-borda: #333;
            --cor-texto-principal: #f0f0f0; --cor-texto-secundario: #bdc3c7;
            --cor-azul: #3498db; --cor-verde: #2ecc71; --cor-vermelho: #e74c3c;
            --cor-amarelo: #f1c40f; --cor-roxo: #8e44ad; --cor-laranja: #f39c12;
        }
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background: var(--cor-fundo); color: var(--cor-texto-principal); margin: 0; padding: 24px; }
        .container { max-width: 1600px; margin: auto; }
        h1, h2 { text-align: center; color: var(--cor-azul); }
        .card { background: linear-gradient(180deg,#1a1a1a,#171717); border: 1px solid var(--cor-borda); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
        .card h2 { margin: 0 0 12px; border-bottom: 1px solid #255b7a; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; align-items: end; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 13px; color: var(--cor-texto-secundario); }
        input, select { padding: 11px 12px; background: #2a2a2a; color: #f0f0f0; border: 1px solid #484848; border-radius: 8px; font-size: 15px; outline: none; }
        input:focus, select:focus { border-color: var(--cor-azul); box-shadow: 0 0 0 3px rgba(52,152,219,.15); }
        .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { border: none; padding: 12px 18px; border-radius: 10px; font-size: 15px; cursor: pointer; transition: .18s ease; }
        .btn:active { transform: translateY(1px); }
        .btn-principal { background: var(--cor-azul); color: #fff; }
        .btn-principal:hover { filter: brightness(1.05); }
        .btn-ghost { background: transparent; color: #dcdcdc; border: 1px solid #555; }
        .resumo-financeiro { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center; }
        .resumo-card h3 { margin: 0; color: var(--cor-texto-secundario); font-size: 0.95rem; }
        .resumo-card p { font-size: 1.8rem; font-weight: 700; margin: 6px 0 0; }
        .colunas-horizontais { display: flex; gap: 20px; align-items: stretch; }
        .coluna { flex: 1; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--cor-borda); vertical-align: middle; }
        thead th { background-color: #22313f; color: #fff; font-weight: 600; letter-spacing: .3px; }
        tbody tr:hover { background-color: #232a34; }
        .valor { text-align: right; white-space: nowrap; }
        .receita { color: var(--cor-verde); }
        .despesa { color: var(--cor-vermelho); }

        .badge { display: inline-flex; align-items: center; gap: 6px; font-weight: 700; border-radius: 999px; padding: 6px 10px; font-size: 12px; text-transform: uppercase; letter-spacing: .3px; }
        .badge.pago { background: rgba(46,204,113,.12); color: #b8f5d2; border: 1px solid rgba(46,204,113,.35); }
        .badge.pendente { background: rgba(241,196,15,.12); color: #f6e7a4; border: 1px solid rgba(241,196,15,.35); }

        .acoes { display: flex; gap: 8px; flex-wrap: wrap; }
        .acao { border: none; padding: 8px 10px; border-radius: 8px; font-size: 12px; color: #fff; cursor: pointer; }
        .acao-pagar { background: var(--cor-verde); }
        .acao-pendente { background: var(--cor-amarelo); color: #222; }
        .acao-editar { background: var(--cor-laranja); }
        .acao-excluir { background: var(--cor-vermelho); }
        .acao-recibo { background: var(--cor-roxo); }

        .dias-wrapper { display: flex; gap: 8px; flex-wrap: wrap; }
        .dias-wrapper label { display: inline-flex; align-items: center; gap: 6px; background: #232323; border: 1px solid #3a3a3a; padding: 6px 10px; border-radius: 999px; color: #e5e5e5; cursor: pointer; }
        .dias-wrapper input { accent-color: var(--cor-azul); }

        .hint { font-size: 12px; color: #9aa7b5; }
        .linkado { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; color: #9ad1ff; }
    </style>
  <style>.topbar{display:flex;justify-content:flex-end;padding:10px 16px}.btn-back{display:inline-block;padding:.55rem .9rem;background:#111827;border:1px solid #334155;border-radius:.6rem;color:#bfdbfe;text-decoration:none;line-height:1}.btn-back:hover{border-color:#3b82f6;color:#dbeafe}</style>
</head>
<body>
<nav class="topbar"><a class="btn-back" href="/admin/index.html">‚Üê Voltar ao Admin</a></nav>
<nav style="text-align:right;padding:10px">
</nav>
<div class="container">
    <h1>Sistema de Controle Financeiro</h1>

    <div class="card resumo-financeiro">
        <div class="resumo-card"><h3><span style="color: var(--cor-verde);">‚óè</span> Total de Receitas</h3><p id="total-receitas" class="receita">R$ 0,00</p></div>
        <div class="resumo-card"><h3><span style="color: var(--cor-vermelho);">‚óè</span> Total de Despesas</h3><p id="total-despesas" class="despesa">R$ 0,00</p></div>
        <div class="resumo-card"><h3><span style="color: var(--cor-azul);">‚óè</span> Saldo Final</h3><p id="saldo-final" class="saldo">R$ 0,00</p></div>
    </div>

    <div class="colunas-horizontais">
        <div class="coluna">
            <div class="card">
                <h2>Adicionar Receita</h2>
                <div class="hint linkado" id="status-integracao">üîó N√£o conectado ao cadastro ainda</div>
                <form id="form-receita">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="aluno-select">Aluno (do cadastro)</label>
                            <select id="aluno-select">
                                <option value="">‚Äî selecionar ‚Äî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aluno">Nome (ou sobrescrever)</label>
                            <input type="text" id="aluno" placeholder="Digite manualmente se quiser" />
                        </div>
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" placeholder="Auto do cadastro, edit√°vel" />
                        </div>
                        <div class="form-group">
                            <label for="item-receita">Item</label>
                            <select id="item-receita" required>
                                <option value="Mensalidade">Mensalidade</option>
                                <option value="Kimono">Kimono</option>
                                <option value="Faixa">Faixa</option>
                                <option value="Vestu√°rio">Vestu√°rio</option>
                                <option value="Exame de Faixa">Exame de Faixa</option>
                                <option value="Certificado">Certificado</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="plano-2025">Plano (2025)</label>
                            <select id="plano-2025">
                                <option value="livre">Livre (valor manual)</option>
                                <option value="2x">2025 ‚Ä¢ 2x/semana ‚Ä¢ R$ 100,00</option>
                                <option value="3x">2025 ‚Ä¢ 3x/semana ‚Ä¢ R$ 150,00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dias da semana</label>
                            <div class="dias-wrapper" id="dias-wrapper">
                                <label><input type="checkbox" value="Seg">Seg</label>
                                <label><input type="checkbox" value="Ter">Ter</label>
                                <label><input type="checkbox" value="Qua">Qua</label>
                                <label><input type="checkbox" value="Qui">Qui</label>
                                <label><input type="checkbox" value="Sex">Sex</label>
                                <label><input type="checkbox" value="S√°b">S√°b</label>
                            </div>
                            <div class="hint">Marque os dias da turma do aluno (opcional, fica salvo no lan√ßamento).</div>
                        </div>
                        <div class="form-group">
                            <label for="valor-receita">Valor (R$)</label>
                            <input type="number" id="valor-receita" step="0.01" required />
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-ghost" id="btn-atualizar-alunos">Atualizar lista de alunos</button>
                            <button type="submit" class="btn btn-principal">Adicionar Receita</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="coluna">
            <div class="card">
                <h2>Adicionar Despesa</h2>
                <form id="form-despesa">
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="descricao-despesa">Descri√ß√£o</label>
                            <input type="text" id="descricao-despesa" required />
                        </div>
                        <div class="form-group">
                            <label for="valor-despesa">Valor (R$)</label>
                            <input type="number" id="valor-despesa" step="0.01" required />
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-principal">Adicionar Despesa</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Hist√≥rico de Lan√ßamentos</h2>
        <table>
            <thead>
            <tr>
                <th>Data</th>
                <th>Descri√ß√£o / Aluno</th>
                <th>Plano / Dias</th>
                <th class="valor">Valor</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="tabela-lancamentos"></tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_FIN = 'kokoro_financeiro_v2';
        const STORAGE_ALUNOS_KEYS = ['kokoro_alunos', 'alunos', 'kokoro_cadastro_alunos']; // tentativas

        const formReceita = document.getElementById('form-receita');
        const formDespesa = document.getElementById('form-despesa');
        const tabelaLancamentos = document.getElementById('tabela-lancamentos');

        const totalReceitasEl = document.getElementById('total-receitas');
        const totalDespesasEl = document.getElementById('total-despesas');
        const saldoFinalEl = document.getElementById('saldo-final');

        const alunoSelect = document.getElementById('aluno-select');
        const alunoInput = document.getElementById('aluno');
        const cpfInput = document.getElementById('cpf');
        const planoSelect = document.getElementById('plano-2025');
        const valorReceitaInput = document.getElementById('valor-receita');
        const diasWrapper = document.getElementById('dias-wrapper');
        const itemReceita = document.getElementById('item-receita');
        const btnAtualizarAlunos = document.getElementById('btn-atualizar-alunos');
        const statusIntegracao = document.getElementById('status-integracao');

        let lancamentos = loadLancamentos();
        let nextId = lancamentos.reduce((max, l) => Math.max(max, l.id), 0) + 1;

        // ‚Äî‚Äî‚Äî‚Äî‚Äî Integra√ß√£o b√°sica com a p√°gina de cadastro (via localStorage) ‚Äî‚Äî‚Äî‚Äî‚Äî
        function loadAlunos() {
            for (const key of STORAGE_ALUNOS_KEYS) {
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw) continue;
                    const data = JSON.parse(raw);
                    if (Array.isArray(data) && data.length) {
                        return { key, alunos: normalizeAlunos(data) };
                    }
                } catch (e) { /* ignore */ }
            }
            return { key: null, alunos: [] };
        }
        function normalizeAlunos(arr) {
            return arr.map(a => ({
                nome: a.nome || a.name || a.aluno || '',
                cpf: a.cpf || a.CPF || a.documento || '',
                id: a.id || a.matricula || a.registro || null,
            })).filter(a => a.nome);
        }
        function populateAlunoSelect() {
            const { key, alunos } = loadAlunos();
            alunoSelect.innerHTML = '<option value="">‚Äî selecionar ‚Äî</option>';
            if (alunos.length) {
                statusIntegracao.textContent = `üîó Conectado ao cadastro via localStorage (chave: ${key})`;
                alunos.sort((a,b)=> a.nome.localeCompare(b.nome, 'pt-BR'));
                alunos.forEach((a, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx; // √≠ndice na lista atual
                    opt.textContent = a.nome + (a.cpf ? ` ‚Ä¢ ${a.cpf}` : '');
                    opt.dataset.cpf = a.cpf || '';
                    alunoSelect.appendChild(opt);
                });
            } else {
                statusIntegracao.textContent = 'üîó N√£o conectado ao cadastro ainda';
            }
        }
        populateAlunoSelect();

        alunoSelect.addEventListener('change', () => {
            const opt = alunoSelect.options[alunoSelect.selectedIndex];
            if (opt && opt.value !== '') {
                alunoInput.value = opt.textContent.split(' ‚Ä¢ ')[0] || '';
                cpfInput.value = opt.dataset.cpf || '';
            }
        });
        btnAtualizarAlunos.addEventListener('click', populateAlunoSelect);

        // ‚Äî‚Äî‚Äî‚Äî‚Äî Planos 2025 autom√°ticos ‚Äî‚Äî‚Äî‚Äî‚Äî
        function aplicarPlanoDefault() {
            if (itemReceita.value !== 'Mensalidade') return; // s√≥ auto para mensalidade
            if (planoSelect.value === '2x') {
                valorReceitaInput.value = 100.00;
                selecionarDias(['Seg','Qua']);
            } else if (planoSelect.value === '3x') {
                valorReceitaInput.value = 150.00;
                selecionarDias(['Seg','Qua','Sex']);
            }
        }
        function selecionarDias(dias) {
            [...diasWrapper.querySelectorAll('input[type="checkbox"]')].forEach(chk => {
                chk.checked = dias.includes(chk.value);
            });
        }
        planoSelect.addEventListener('change', aplicarPlanoDefault);
        itemReceita.addEventListener('change', () => {
            // Se trocar item e n√£o for Mensalidade, volta para livre
            if (itemReceita.value !== 'Mensalidade') {
                planoSelect.value = 'livre';
            } else {
                aplicarPlanoDefault();
            }
        });

        // ‚Äî‚Äî‚Äî‚Äî‚Äî Persist√™ncia ‚Äî‚Äî‚Äî‚Äî‚Äî
        function loadLancamentos() {
            try {
                const raw = localStorage.getItem(STORAGE_FIN);
                if (!raw) return [];
                const data = JSON.parse(raw);
                return Array.isArray(data) ? data : [];
            } catch (e) {
                return [];
            }
        }
        function saveLancamentos() {
            localStorage.setItem(STORAGE_FIN, JSON.stringify(lancamentos));
        }

        // ‚Äî‚Äî‚Äî‚Äî‚Äî Renderiza√ß√£o ‚Äî‚Äî‚Äî‚Äî‚Äî
        function formatarMoeda(valor) {
            return (Number(valor)||0).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
        }
        function coletarDiasSelecionados() {
            return [...diasWrapper.querySelectorAll('input[type="checkbox"]:checked')].map(i => i.value);
        }

        function renderizar() {
            tabelaLancamentos.innerHTML = '';
            let totalReceitas = 0; let totalDespesas = 0;

            lancamentos.forEach(l => {
                const tr = document.createElement('tr');
                const isReceita = l.tipo === 'receita';

                const badge = `<span class="badge ${l.status}">${l.status}</span>`;
                const planoDias = isReceita ? `${l.planoLabel || '-'}${(l.dias && l.dias.length)? ' ‚Ä¢ ' + l.dias.join(', ') : ''}` : '-';

                tr.innerHTML = `
            <td>${l.data}</td>
            <td>${isReceita ? (l.aluno || l.descricao || '-') + (l.cpf? ` <small style="color:#8aa0b2">(CPF: ${l.cpf})</small>` : '') : (l.descricao || '-')}</td>
            <td>${planoDias}</td>
            <td class="valor ${isReceita ? 'receita' : 'despesa'}">${formatarMoeda(l.valor)}</td>
            <td>${badge}</td>
            <td class="acoes">
              <button class="acao acao-pagar" data-id="${l.id}" data-action="pagar">Pago</button>
              <button class="acao acao-pendente" data-id="${l.id}" data-action="pendente">Pendente</button>
              <button class="acao acao-editar" data-id="${l.id}" data-action="editar">Editar</button>
              <button class="acao acao-excluir" data-id="${l.id}" data-action="excluir">Excluir</button>
              ${isReceita && l.status === 'pago' ? `<button class="acao acao-recibo" data-id="${l.id}" data-action="recibo">Recibo</button>` : ''}
            </td>`;

                tabelaLancamentos.appendChild(tr);

                if (l.status === 'pago') {
                    if (isReceita) totalReceitas += Number(l.valor)||0; else totalDespesas += Number(l.valor)||0;
                }
            });

            totalReceitasEl.textContent = formatarMoeda(totalReceitas);
            totalDespesasEl.textContent = formatarMoeda(totalDespesas);
            saldoFinalEl.textContent = formatarMoeda(totalReceitas - totalDespesas);
            saveLancamentos();
        }

        // ‚Äî‚Äî‚Äî‚Äî‚Äî Adi√ß√µes ‚Äî‚Äî‚Äî‚Äî‚Äî
        formReceita.addEventListener('submit', (e) => {
            e.preventDefault();
            const dias = coletarDiasSelecionados();
            const plano = planoSelect.value; // livre | 2x | 3x
            const planoLabel = plano === '2x' ? '2025 ‚Ä¢ 2x/semana' : (plano === '3x' ? '2025 ‚Ä¢ 3x/semana' : 'Livre');

            lancamentos.push({
                id: nextId++, tipo: 'receita', data: new Date().toLocaleDateString('pt-br'),
                aluno: alunoInput.value || alunoSelect.options[alunoSelect.selectedIndex]?.textContent?.split(' ‚Ä¢ ')[0] || '',
                cpf: cpfInput.value || '', item: itemReceita.value,
                plano, planoLabel, ano: 2025, dias,
                valor: parseFloat(valorReceitaInput.value), status: 'pendente'
            });
            renderizar();
            formReceita.reset();
            planoSelect.value = 'livre';
        });

        formDespesa.addEventListener('submit', (e) => {
            e.preventDefault();
            lancamentos.push({
                id: nextId++, tipo: 'despesa', data: new Date().toLocaleDateString('pt-br'),
                descricao: document.getElementById('descricao-despesa').value,
                valor: parseFloat(document.getElementById('valor-despesa').value),
                status: 'pago'
            });
            renderizar();
            formDespesa.reset();
        });

        // ‚Äî‚Äî‚Äî‚Äî‚Äî A√ß√µes na tabela ‚Äî‚Äî‚Äî‚Äî‚Äî
        tabelaLancamentos.addEventListener('click', (e) => {
            const btn = e.target.closest('button.acao');
            if (!btn) return;
            const id = parseInt(btn.dataset.id);
            const acao = btn.dataset.action;
            const l = lancamentos.find(x => x.id === id);
            if (!l) return;

            if (acao === 'pagar') {
                l.status = 'pago';
            } else if (acao === 'pendente') {
                l.status = 'pendente';
            } else if (acao === 'editar') {
                const novoValor = prompt('Novo valor (R$):', l.valor);
                if (novoValor && !isNaN(novoValor)) l.valor = parseFloat(novoValor);
            } else if (acao === 'excluir') {
                if (confirm('Tem certeza que deseja excluir este lan√ßamento?')) {
                    lancamentos = lancamentos.filter(x => x.id !== id);
                }
            } else if (acao === 'recibo') {
                alert('Recibo enviado! (A implementar no back-end)');
            }
            renderizar();
        });

        // Primeira renderiza√ß√£o
        renderizar();
        // Aplicar plano default se j√° est√° Mensalidade
        aplicarPlanoDefault();
    });
</script>
</body>
</html>
